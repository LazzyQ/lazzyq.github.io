---
title: "【译】系统设计:WhatsApp"
date: 2021-05-06T23:54:36+08:00
draft: false
original: true
categories: 
  - "系统设计"
tags: 
  - "系统设计"
---

英文原文: [System Design: WhatsApp](https://interviewdaemon.medium.com/system-design-whatsapp-788705bd4fb0)

系统设计 Whatsapp. WhatsApp Messenger，或简称WhatsApp，是美国的一个集中式信息传递和IP语音（VoIP）服务。它允许用户发送文本信息和语音信息，进行语音和视频通话，并分享图像、文件、用户位置和其他媒体。

# 简介
它允许用户发送文本信息和语音信息，进行语音和视频通话，并分享图像、文档、用户位置和其他媒体。

<!--more-->

# 需求

* 支持一对一的聊天
* 支持群组聊天
* 支持图像、文件、视频共享
* 支持用户最后看到的时间
* 支持信息的已读/已送达勾选收据
* 系统应该是高度可用的
* 系统应该是可扩展的
* 系统应该是低延迟的


# 高层次的系统设计

在高层次上，我们需要支持当前系统中的多个微服务。

![](/【译】系统设计WhatsApp/whatsapp.png)

# Whatsapp消息流程

* 用户1发送消息给用户2
* 用户1连接到Web套接字处理程序WSH1。因此，当User-1决定发送消息给User-2时，它将此信息传达给WSH1。然后，WSH1将与Web套接字管理器交谈,找出哪个Websocket handler在处理User-2，Web套接字管理器将回应说User-2连接到WSH2。
* WSH1将平行调用消息服务，该服务将把消息保存到Cassandra，并给它分配一个消息ID，如M1。现在WSH1有一个消息ID M1，并且知道U2连接到WSH2，它将与WSH2对话
* 用户1在离线状态下发送（在没有互联网的情况下发送消息）。
* 我们可以将消息存储在设备缓存中。
* 一旦User-1设备在线，我们将从设备本地数据库中提取所有的消息并发送。

**如果User-2是在线的**

* User-2可能在User-1的聊天屏幕上，在这种情况下，M1将被立即传递和看到，或者可能不在U1的聊天屏幕上，在这种情况下，消息将只被传递。

**如果用户2是离线的**

* WSH1与网络套接字管理器对话，找出哪个处理程序与用户-2连接，发现用户-2没有与任何人连接，所以这部分流程在此结束。
* 它也在与消息服务对话，在那里消息被储存了一个ID，例如M2。
* 现在，当用户2上线时，假设它连接到WSH3，WSH3做的第一件事是与消息服务进行检查，如果有任何未交付的消息给用户2，这些消息将通过WSH3发送给用户2。
* 然后，WSH3将以之前讨论的方式向WSH1传达这一状态的变化。

**当用户-1发送消息并处于离线状态时**

* 用户-1发送消息给用户-2，然后用户-1就离线了。
* 用户-2已经收到了消息M1，但用户-1不知道它。
* 因此，至少在它没有被传达给User-1的时候，状态将被存储在Cassandra中，与消息相对应的是交付或看到。
* 一旦用户-1收到消息的状态，如果需要，可以删除它。

**比赛条件**

* 如果用户-2是离线的，当它上线后，Web Socket Manager与WSH3对话，以获得所有没有交付给用户-2的消息。
* 当对话时，用户-2再次回到离线状态。
* 有两件事会发生

1. WSH3得到消息并发送至WSH1。WSH1认为User-2是离线的，并将消息存储在消息服务中，并认为其工作已经完成。实际上用户2并不在线。
2. 用户-2在线了一段时间，所有的消息都被传递了。

* 为了避免这种情况，Web Socket处理程序将进行Web轮询，在固定的时间间隔后跟踪消息的情况


# 组件设计

## websocket handler

* websocket handler是一个轻量级的服务器，它将与所有活跃的用户保持一个开放的连接。
* 一个网络套接字可以有大约6500-70000个连接。
* Facebook/Whatsapp的规模 一个网络套接字处理程序不足以支持所有用户，所以在我们的系统中会有多个网络套接字处理程序。
* 通过缓存两件事来减少对处理程序的调用
* 哪些用户连接到自己，所以如果U1和U2都连接到同一个处理程序，就可以避免对网络套接字管理器的调用。
* 关于最近对话的信息，比如哪个用户连接到哪个处理程序。

## websocket manager

* 一个网络套接字处理程序将被连接到一个网络套接字管理器，这是一个关于哪些网络套接字处理程序被连接到哪些用户的信息库。
* 它位于Redis之上，存储两种类型的信息
* 哪个用户连接到哪个网络套接字处理器
* 哪些用户被连接到了特定的网络套接字处理程序上

## 消息服务

*  消息服务，是系统中所有消息的储存库。
* 一个网络套接字处理程序，在与网络套接字管理器交谈的同时，也会与一个消息服务交谈，它是系统中所有消息的存储库。
* 它将公开API，通过各种过滤器获取消息，如用户ID、消息ID、交付状态等。
* 这个消息服务位于Cassandra的顶部。
* 现在我们可以预期，每天都会有新的用户加入系统，所有的用户，无论新旧，每天都会有新的对话，也就是说，消息服务需要建立在一个可以处理不断增加的数据的数据存储之上。
* Facebook永久保存信息，而Whatsapp/Snapchat一旦阅读后就会删除信息并永久保存。

## 用户服务

* 存储与用户有关的信息，如姓名、ID、个人资料图片、偏好等，通常。
* 用户可以存储在MySQL数据库中。
* 信息也被缓存在Redis中。

## 组服务

* 维护所有与组相关的信息，如哪个用户属于哪个组、用户ID、组ID、组的创建时间、每个用户的添加时间、状态、组的图标等。
* 组服务也可以将所有的数据存储在MySQL的主站和从站。
* 信息也被缓存在Redis中。
* 网络套接字处理程序不会跟踪组，它只是跟踪活跃的用户。
* 因此，当User-1想向Group-1发送消息时，WSH1与Message Service取得联系，说User-1想向Group-1发送消息，并将其作为M3存储在Cassandra中。
* 消息服务现在将与Kafka通信。
* M3被保存在Kafka中，并有一个指令，即它必须被发送到Group-1。
* 现在Kafka将与被称为组消息处理程序的东西进行交互。
* 组消息处理程序监听Kafka并发送所有的组消息。
* 组消息处理程序与组服务对话，找出G1中的所有用户，并遵循与网络套接字处理程序相同的过程，将消息单独发送给所有用户。

## 资产服务

* 当这样的内容被发送出去时，它将在设备端被压缩和加密，加密的内容将被发送到接收器。
* 即使在接收时，内容也将以加密格式接收，并在设备端进行解密。
* 用户1发送图片给用户2
* 用户-1将上传图像到一个服务器，并获得图像ID-1。
* 然后它将发送图像ID-1给用户2，用户2可以从服务器上搜索和下载图像。
* Web Socket处理程序是轻量级的，因此Web Socket处理程序中没有逻辑。
* 图像将在设备端被压缩，并通过负载平衡器发送到资产服务，资产服务将把内容存储在文件存储（S3）。
* 优化/如何处理消息图像转发（同一图像的多个副本）。
* 在上传图片到资产服务之前，用户-1将发送图片的哈希值，如果哈希值在资产服务中已经存在，内容将不会被再次上传，但针对同一图片/内容的ID将被
* 送给用户-2。
* 我们可以做多次散列以避免碰撞。

## 分析服务

* 事件被发送到一个分析服务，该服务将它们发送到Kafka，或者在消息的情况下，直接发送到Kafka。
* Kafka可以进一步连接到Spark流媒体服务，该服务要么在内容流入时进行分析，要么将其转入Hadoop集群，该集群可以运行各种各样的查询。

## 最后看到的服务

* Last Seen服务记录了用户最后看到的时间。
* 我们可以在Redis(Cache)或Cassandra中以用户ID和最后看到的时间的形式使用。
* 事件可以有两种类型，一种是由应用程序触发的事件，另一种是由用户触发的事件。
* 应用程序的事件--比如当一个网络套接字连接被创建时，等等。这些事件不会被最后看到的服务所追踪。
* 用户事件--如用户打开、关闭或在应用中做其他事情。这些事件将被用来跟踪最后看到的时间。

# API 设计

我们可以使用REST或SOAP来服务我们的API。基本上，照片和视频共享服务系统将有以下重要的API。


##  postMessage

```
postMessage(api_dev_key, message_text, user_id, media_id)
```

# 数据库

* Web Socket Manager将数据存储在Redis(Cache)中，以存储以下内容。
* 哪个用户连接到哪个网络套接字处理程序
* 哪些用户连接到了特定的网络套接字处理程序？
* 消息服务，使用Cassandra，因为它很容易查询。
* 用户服务使用Redis(Cache)和MySQL来存储用户相关的细节。
* 组服务使用Redis(Cache)和MySQL来存储组的相关细节。
* 最后看到的用户的详细信息，如userId和时间戳，可以存储在Cassandra中。
* 我们使用Kafka进行群组信息传递和分析或任何其他数据流。
* HDFS用于旧的存储。
* 资产服务使用
* CDN用于缓存图像
* 文件存储（S3）用于存储文件对象


#  缓存和负载平衡


我们可以为元数据服务器引入一个缓存（Redis）来缓存热数据库行。最近最少使用（LRU）可以是我们系统的一个合理的缓存驱逐策略。(Whatsapp我们可以使用Redis)

我们怎样才能建立一个更智能的缓存？如果我们按照八二法则，即20%的照片日阅读量产生了80%的流量，这意味着某些照片非常受欢迎，大多数人都在阅读。这就决定了我们可以尝试缓存20%的照片和元数据的日阅读量。

# 参考资料

* [Code Karle](https://www.codekarle.com/system-design/Whatsapp-system-design.html)