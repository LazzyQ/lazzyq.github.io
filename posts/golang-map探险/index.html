<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.80.0" /><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Golang mapæ¢é™© | æ‡’ç™Œæ­£æ‚£è€…</title>

    <link rel="stylesheet" href="/css/meme.min.2f9232918b45a8f83b406469874e2be32093cd97e79e0840dbff3f1f122ad6ca.css"/>

    
    
        <script src="/js/meme.min.434274bb2302fe029f98d3d29ae57dab1566be565436f52a6dd93089085533c4.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" /></noscript>

    <meta name="author" content="æ‡’ç™Œæ­£æ‚£è€…" /><meta name="description" content="å‰è¨€ mapæ˜¯ä¸€ç§å¾ˆåŸºç¡€çš„æ•°æ®ç»“æ„ï¼ŒJavaä¸­çš„HashMapä½¿ç”¨æ•°ç»„&#43;é“¾è¡¨çš„æ–¹å¼æ¥å®ç°ï¼ŒGolangå†…ç½®mapåº•å±‚æ˜¯ä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ
å†…å­˜ç»“æ„ åœ¨goä¸­mapä½¿ç”¨çš„æ˜¯hmapè¿™ä¸ªç»“æ„æ¥è¡¨ç¤º
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // A header for a Go map. type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. 	// Make sure this stays in sync with the compiler&#39;s definition. 	count int // map ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå¿…é¡»æ”¾åœ¨ struct çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå› ä¸º å†…ç½®çš„ len å‡½æ•°ä¼šä»è¿™é‡Œè¯»å– 	flags uint8 B uint8 // log_2 of # of buckets (æœ€å¤šå¯ä»¥æ”¾ loadFactor * 2^B ä¸ªå…ƒç´ ï¼Œå†å¤šå°±è¦ hashGrow äº†) 	noverflow uint16 // overflow çš„ bucket çš„è¿‘ä¼¼æ•° 	hash0 uint32 // hash seed  buckets unsafe.Pointer // 2^B å¤§å°çš„æ•°ç»„ï¼Œå¦‚æœ count == 0 çš„è¯ï¼Œå¯èƒ½æ˜¯ nil 	oldbuckets unsafe.Pointer // ä¸€åŠå¤§å°çš„ä¹‹å‰çš„ bucket æ•°ç»„ï¼Œåªæœ‰åœ¨ growing è¿‡ç¨‹ä¸­æ˜¯é nil 	nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated)  extra *mapextra // å½“ key å’Œ value éƒ½å¯ä»¥ inline çš„æ—¶å€™ï¼Œå°±ä¼šç”¨è¿™ä¸ªå­—æ®µ }   â€¦â€¦" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="æ‡’ç™Œæ­£æ‚£è€…" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="æ‡’ç™Œæ­£æ‚£è€…" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2020-12-05T23:06:41+08:00",
        "dateModified": "2020-12-18T20:31:14+08:00",
        "url": "http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/",
        "headline": "Golang mapæ¢é™©",
        "description": "å‰è¨€ mapæ˜¯ä¸€ç§å¾ˆåŸºç¡€çš„æ•°æ®ç»“æ„ï¼ŒJavaä¸­çš„HashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨çš„æ–¹å¼æ¥å®ç°ï¼ŒGolangå†…ç½®mapåº•å±‚æ˜¯ä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ\nå†…å­˜ç»“æ„ åœ¨goä¸­mapä½¿ç”¨çš„æ˜¯hmapè¿™ä¸ªç»“æ„æ¥è¡¨ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // A header for a Go map. type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. \t// Make sure this stays in sync with the compiler's definition. \tcount int // map ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå¿…é¡»æ”¾åœ¨ struct çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå› ä¸º å†…ç½®çš„ len å‡½æ•°ä¼šä»è¿™é‡Œè¯»å– \tflags uint8 B uint8 // log_2 of # of buckets (æœ€å¤šå¯ä»¥æ”¾ loadFactor * 2^B ä¸ªå…ƒç´ ï¼Œå†å¤šå°±è¦ hashGrow äº†) \tnoverflow uint16 // overflow çš„ bucket çš„è¿‘ä¼¼æ•° \thash0 uint32 // hash seed  buckets unsafe.Pointer // 2^B å¤§å°çš„æ•°ç»„ï¼Œå¦‚æœ count == 0 çš„è¯ï¼Œå¯èƒ½æ˜¯ nil \toldbuckets unsafe.Pointer // ä¸€åŠå¤§å°çš„ä¹‹å‰çš„ bucket æ•°ç»„ï¼Œåªæœ‰åœ¨ growing è¿‡ç¨‹ä¸­æ˜¯é nil \tnevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated)  extra *mapextra // å½“ key å’Œ value éƒ½å¯ä»¥ inline çš„æ—¶å€™ï¼Œå°±ä¼šç”¨è¿™ä¸ªå­—æ®µ }   â€¦â€¦",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  11211 ,
        "image": ["http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/bmap.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/bmap%E9%93%BE.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap%E6%95%B4%E4%BD%93.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/%E8%AE%BF%E9%97%AEmap.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/range%E9%81%8D%E5%8E%86map.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/map%E9%81%8D%E5%8E%86.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/SameSizeGrow.png","http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/BiggerSizeGrow.png"],
        "author": {
            "@type": "Person",
            "description": "Viva La Vida",
            "email": "zengqiang96@gmail.com",
            "image": "http://www.wemeng.top/icons/apple-touch-icon.png",
            "url": "https://www.wemeng.top/",
            "name": "æ‡’ç™Œæ­£æ‚£è€…"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)",
        "publisher": {
            "@type": "Organization",
            "name": "æ‡’ç™Œæ­£æ‚£è€…",
            "logo": {
                "@type": "ImageObject",
                "url": "http://www.wemeng.top/icons/apple-touch-icon.png"
            },
            "url": "http://www.wemeng.top/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "http://www.wemeng.top/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />


<meta name="twitter:site" content="@æ‡’ç™Œæ­£æ‚£è€…" />
<meta name="twitter:creator" content="@æ‡’ç™Œæ­£æ‚£è€…" />

    



<meta property="og:title" content="Golang mapæ¢é™©" />
<meta property="og:description" content="å‰è¨€ mapæ˜¯ä¸€ç§å¾ˆåŸºç¡€çš„æ•°æ®ç»“æ„ï¼ŒJavaä¸­çš„HashMapä½¿ç”¨æ•°ç»„&#43;é“¾è¡¨çš„æ–¹å¼æ¥å®ç°ï¼ŒGolangå†…ç½®mapåº•å±‚æ˜¯ä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ
å†…å­˜ç»“æ„ åœ¨goä¸­mapä½¿ç”¨çš„æ˜¯hmapè¿™ä¸ªç»“æ„æ¥è¡¨ç¤º
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // A header for a Go map. type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. 	// Make sure this stays in sync with the compiler&#39;s definition. 	count int // map ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå¿…é¡»æ”¾åœ¨ struct çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå› ä¸º å†…ç½®çš„ len å‡½æ•°ä¼šä»è¿™é‡Œè¯»å– 	flags uint8 B uint8 // log_2 of # of buckets (æœ€å¤šå¯ä»¥æ”¾ loadFactor * 2^B ä¸ªå…ƒç´ ï¼Œå†å¤šå°±è¦ hashGrow äº†) 	noverflow uint16 // overflow çš„ bucket çš„è¿‘ä¼¼æ•° 	hash0 uint32 // hash seed  buckets unsafe.Pointer // 2^B å¤§å°çš„æ•°ç»„ï¼Œå¦‚æœ count == 0 çš„è¯ï¼Œå¯èƒ½æ˜¯ nil 	oldbuckets unsafe.Pointer // ä¸€åŠå¤§å°çš„ä¹‹å‰çš„ bucket æ•°ç»„ï¼Œåªæœ‰åœ¨ growing è¿‡ç¨‹ä¸­æ˜¯é nil 	nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated)  extra *mapextra // å½“ key å’Œ value éƒ½å¯ä»¥ inline çš„æ—¶å€™ï¼Œå°±ä¼šç”¨è¿™ä¸ªå­—æ®µ }   â€¦â€¦" />
<meta property="og:url" content="http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/" />
<meta property="og:site_name" content="æ‡’ç™Œæ­£æ‚£è€…" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap.png" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-12-05T23:06:41&#43;08:00" />
    <meta property="article:modified_time" content="2020-12-18T20:31:14&#43;08:00" />
    
    <meta property="article:section" content="posts" />



    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">æ‡’ç™Œæ­£æ‚£è€…</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">æ–‡ç« </span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">åˆ†ç±»</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">æ ‡ç­¾</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">å…³äº</span></a>
                </li>
            
        
            
                
                    
                    
                        <li class="menu-item">
                            <a id="theme-switcher" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5l48.8-97.5a18 18 0 0128 0l48.8 97.5 103.4 -34.5a18 18 0 0119.8 19.8l-34.5 103.4l97.5 48.8a18 18 0 010 28l-97.5 48.8 34.5 103.4a18 18 0 01-19.8 19.8l-103.4-34.5-48.8 97.5a18 18 0 01-28 0l-48.8-97.5l-103.4 34.5a18 18 0 01-19.8-19.8l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8-34.5-103.4a18 18 0 0119.8-19.8zM256 128a128 128 0 10.01 0M256 160a96 96 0 10.01 0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412a256 256 0 10154-407a11.5 11.5 0 00-5 20a201.5 201.5 0 01-134 374a11.5 11.5 0 00-15 13"/></svg></a>
                        </li>
                    
                
            
        
            
                
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="justify" data-type="posts">

            <h1 class="post-title p-name">Golang mapæ¢é™©</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2020-12-05T23:06:41&#43;08:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;2020.12.5</time>
    
    
        
        <time datetime="2020-12-18T20:31:14&#43;08:00" class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2020.12.18</time>
    
    
    
        
        
        
            
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/golang/" class="category-link p-category">Golang</a></span>
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;11211</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;23&nbsp;åˆ†é’Ÿ</span>
    
    
    
</div>

            

            <nav class="contents">
  <h2 id="contents" class="contents-title">ç›®å½•</h2><ol class="toc">
    <li>
      <ol>
        <li><a id="contents:å‰è¨€" href="#å‰è¨€">å‰è¨€</a></li>
        <li><a id="contents:å†…å­˜ç»“æ„" href="#å†…å­˜ç»“æ„">å†…å­˜ç»“æ„</a></li>
        <li><a id="contents:åˆ›å»ºmap" href="#åˆ›å»ºmap">åˆ›å»ºmap</a></li>
        <li><a id="contents:è®¿é—®map" href="#è®¿é—®map">è®¿é—®map</a></li>
        <li><a id="contents:å†™å…¥map" href="#å†™å…¥map">å†™å…¥map</a></li>
        <li><a id="contents:mapæ‰©å®¹" href="#mapæ‰©å®¹">mapæ‰©å®¹</a></li>
        <li><a id="contents:mapåˆ é™¤" href="#mapåˆ é™¤">mapåˆ é™¤</a></li>
        <li><a id="contents:indirectkey-å’Œ-indirectvalue" href="#indirectkey-å’Œ-indirectvalue">indirectkey å’Œ indirectvalue</a></li>
        <li><a id="contents:overflow-å¤„ç†" href="#overflow-å¤„ç†">overflow å¤„ç†</a></li>
        <li><a id="contents:å‚è€ƒèµ„æ–™" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
      </ol>
    </li>
  </ol>
</nav><div class="post-body e-content">
              <h3 id="å‰è¨€"><a href="#å‰è¨€" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:å‰è¨€" class="headings">å‰è¨€</a></h3>
<p>mapæ˜¯ä¸€ç§å¾ˆåŸºç¡€çš„æ•°æ®ç»“æ„ï¼ŒJavaä¸­çš„HashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨çš„æ–¹å¼æ¥å®ç°ï¼ŒGolangå†…ç½®mapåº•å±‚æ˜¯ä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ</p>
<h3 id="å†…å­˜ç»“æ„"><a href="#å†…å­˜ç»“æ„" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:å†…å­˜ç»“æ„" class="headings">å†…å­˜ç»“æ„</a></h3>
<p>åœ¨goä¸­mapä½¿ç”¨çš„æ˜¯<code>hmap</code>è¿™ä¸ªç»“æ„æ¥è¡¨ç¤º</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// A header for a Go map.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">hmap</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.
</span><span class="c1"></span>	<span class="c1">// Make sure this stays in sync with the compiler&#39;s definition.
</span><span class="c1"></span>	<span class="nx">count</span>     <span class="kt">int</span> <span class="c1">// map ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå¿…é¡»æ”¾åœ¨ struct çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå› ä¸º å†…ç½®çš„ len å‡½æ•°ä¼šä»è¿™é‡Œè¯»å–
</span><span class="c1"></span>	<span class="nx">flags</span>     <span class="kt">uint8</span>
	<span class="nx">B</span>         <span class="kt">uint8</span>  <span class="c1">// log_2 of # of buckets (æœ€å¤šå¯ä»¥æ”¾ loadFactor * 2^B ä¸ªå…ƒç´ ï¼Œå†å¤šå°±è¦ hashGrow äº†)
</span><span class="c1"></span>	<span class="nx">noverflow</span> <span class="kt">uint16</span> <span class="c1">// overflow çš„ bucket çš„è¿‘ä¼¼æ•°
</span><span class="c1"></span>	<span class="nx">hash0</span>     <span class="kt">uint32</span> <span class="c1">// hash seed
</span><span class="c1"></span>
	<span class="nx">buckets</span>    <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// 2^B å¤§å°çš„æ•°ç»„ï¼Œå¦‚æœ count == 0 çš„è¯ï¼Œå¯èƒ½æ˜¯ nil
</span><span class="c1"></span>	<span class="nx">oldbuckets</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// ä¸€åŠå¤§å°çš„ä¹‹å‰çš„ bucket æ•°ç»„ï¼Œåªæœ‰åœ¨ growing è¿‡ç¨‹ä¸­æ˜¯é nil
</span><span class="c1"></span>	<span class="nx">nevacuate</span>  <span class="kt">uintptr</span>        <span class="c1">// progress counter for evacuation (buckets less than this have been evacuated)
</span><span class="c1"></span>
	<span class="nx">extra</span> <span class="o">*</span><span class="nx">mapextra</span> <span class="c1">// å½“ key å’Œ value éƒ½å¯ä»¥ inline çš„æ—¶å€™ï¼Œå°±ä¼šç”¨è¿™ä¸ªå­—æ®µ
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p><img src="/Golang-map%E6%8E%A2%E9%99%A9/hmap.png" alt="hmapç»“æ„"></p>
<p>å…¶ä¸­<code>buckets</code>å­—æ®µæŒ‡å‘bucketæ•°ç»„ç»“æ„ï¼Œè¿™ä¸ªbucketæ•°ç»„çš„é•¿åº¦æ˜¯2^B</p>
<p>bucketæ˜¯ç”¨<code>bmap</code>è¿™ä¸ªç»“æ„æ¥è¡¨ç¤ºçš„</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
  <span class="c1">// Maximum number of key/elem pairs a bucket can hold.
</span><span class="c1"></span>  <span class="nx">bucketCntBits</span> <span class="p">=</span> <span class="mi">3</span>
  <span class="nx">bucketCnt</span>     <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nx">bucketCntBits</span>
<span class="p">)</span>

<span class="c1">// A bucket for a Go map.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">bmap</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// tophash generally contains the top byte of the hash value
</span><span class="c1"></span>	<span class="c1">// for each key in this bucket. If tophash[0] &lt; minTopHash,
</span><span class="c1"></span>	<span class="c1">// tophash[0] is a bucket evacuation state instead.
</span><span class="c1"></span>	<span class="nx">tophash</span> <span class="p">[</span><span class="nx">bucketCnt</span><span class="p">]</span><span class="kt">uint8</span>
	<span class="c1">// Followed by bucketCnt keys and then bucketCnt elems.
</span><span class="c1"></span>	<span class="c1">// NOTE: packing all the keys together and then all the elems together makes the
</span><span class="c1"></span>	<span class="c1">// code a bit more complicated than alternating key/elem/key/elem/... but it allows
</span><span class="c1"></span>	<span class="c1">// us to eliminate padding which would be needed for, e.g., map[int64]int8.
</span><span class="c1"></span>	<span class="c1">// Followed by an overflow pointer.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">mapextra</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// å¦‚æœ key å’Œ value éƒ½ä¸åŒ…å«æŒ‡é’ˆï¼Œå¹¶ä¸”å¯ä»¥è¢« inline(&lt;=128 å­—èŠ‚)
</span><span class="c1"></span>    <span class="c1">// ä½¿ç”¨ extra æ¥å­˜å‚¨ overflow bucketï¼Œè¿™æ ·å¯ä»¥é¿å… GC æ‰«ææ•´ä¸ª map
</span><span class="c1"></span>    <span class="c1">// ç„¶è€Œ bmap.overflow ä¹Ÿæ˜¯ä¸ªæŒ‡é’ˆã€‚è¿™æ—¶å€™æˆ‘ä»¬åªèƒ½æŠŠè¿™äº› overflow çš„æŒ‡é’ˆ
</span><span class="c1"></span>    <span class="c1">// éƒ½æ”¾åœ¨ hmap.extra.overflow å’Œ hmap.extra.oldoverflow ä¸­äº†
</span><span class="c1"></span>    <span class="c1">// overflow åŒ…å«çš„æ˜¯ hmap.buckets çš„ overflow çš„ bucket
</span><span class="c1"></span>    <span class="c1">// oldoverflow åŒ…å«æ‰©å®¹æ—¶çš„ hmap.oldbuckets çš„ overflow çš„ bucket
</span><span class="c1"></span>    <span class="nx">overflow</span>    <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>
    <span class="nx">oldoverflow</span> <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>

    <span class="c1">// æŒ‡å‘ç©ºé—²çš„ overflow bucket çš„æŒ‡é’ˆ
</span><span class="c1"></span>    <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ç„¶è€Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œç”±äºmapå¯ä»¥å­˜å‚¨ä¸åŒç±»å‹çš„é”®å€¼ï¼Œç›®å‰goä¹Ÿä¸æ”¯æŒæ³›å‹ï¼Œæ‰€ä»¥é”®å€¼å æ®çš„å†…å­˜ç©ºé—´å¤§å°åªèƒ½åœ¨ç¼–è¯‘æ—¶æœŸè¿›è¡Œæ¨å¯¼ï¼Œç¼–è¯‘æœŸé—´<code>cmd/compile/internal/gc/reflect.go#bmap</code>ä¼šç»™åŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">bmap</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">topbits</span>  <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
    <span class="nx">keys</span>     <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="nx">keytype</span> 
    <span class="nx">values</span>   <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="nx">valuetype</span>
    <span class="nx">pad</span>      <span class="kt">uintptr</span>
    <span class="nx">overflow</span> <span class="kt">uintptr</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p><img src="/Golang-map%E6%8E%A2%E9%99%A9/bmap.png" alt="bmapç»“æ„"></p>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸ªæ¡¶å­˜å‚¨çš„é”®å€¼å¯¹çš„ä¸ªæ•°æ˜¯å›ºå®šçš„8ä¸ªï¼Œè€Œä¸”keyå’Œvalueçš„å½¢å¼å¹¶ä¸åƒJavaä¸­ä½¿ç”¨Map.Entry&lt;K,V&gt;è¿™ç§æ–¹å¼å­˜å‚¨ï¼Œè€Œæ˜¯8ä¸ªkeyæ”¾åœ¨ä¸€èµ·ï¼Œ8ä¸ªvalueæ”¾åœ¨ä¸€èµ·ï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼Œåªéœ€è¦åœ¨æœ€åè¿›è¡Œè¡¥é½ï¼Œä¸ç”¨ä¸ºæ¯ä¸ªMap.Entry&lt;K,V&gt;è¿›è¡Œè¡¥é½</p>
<p>å¦‚æœbucketä¸­8ä¸ªä½ç½®éƒ½æ»¡äº†ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„bucketï¼Œå¹¶ç”¨overflowæŒ‡å‘è¿™ä¸ªæ–°çš„bucket</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/bmap%E9%93%BE.png" alt="bmapé“¾"></p>
<p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬äº†è§£åˆ°çš„mapå°±æ˜¯è¿™ä¸ªæ ·å­çš„</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/hmap%E6%95%B4%E4%BD%93.png" alt="bmapç»“æ„"></p>
<h3 id="åˆ›å»ºmap"><a href="#åˆ›å»ºmap" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:åˆ›å»ºmap" class="headings">åˆ›å»ºmap</a></h3>
<p>å¹³æ—¶æˆ‘ä»¬åˆ›å»ºmapæœ‰å¾ˆå¤šç§æ–¹å¼ï¼š</p>
<p>å­—é¢é‡çš„æ–¹å¼åˆ›å»º</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">hash</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
	<span class="s">&#34;1&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
	<span class="s">&#34;3&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
	<span class="s">&#34;5&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ä½¿ç”¨å­—é¢é‡çš„æ–¹å¼åˆå§‹åŒ–mapï¼Œæœ€ç»ˆéƒ½ä¼šé€šè¿‡<code>cmd/compile/internal/gc.maplit</code>å‡½æ•°åˆå§‹åŒ–ï¼Œè¯¦æƒ…å¯å‚è§<a href="https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-hashmap/#%E5%AD%97%E9%9D%A2%E9%87%8F" target="_blank" rel="noopener">å­—é¢é‡åˆå§‹åŒ–map</a></p>
<p>ä½¿ç”¨makeä¸æŒ‡å®šå¤§å°çš„æ–¹å¼</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">hash</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ä½¿ç”¨makeæŒ‡å®šå¤§å°çš„æ–¹å¼</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">hash</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><p>åœ¨è¿è¡Œæ—¶ä½¿ç”¨makeåˆå§‹åŒ–mapï¼Œè¿™ç§æ–¹å¼ç”±ç¼–è¯‘å™¨æ¥ç¡®å®šå¦‚ä½•åˆå§‹åŒ–ï¼Œå…¥å£åœ¨<code>cmd/compile/internal/gc/walk.go</code>ä¸­<code>case OMAKEMAP:</code>åˆ†æ”¯ï¼Œä¼šæ ¹æ®æ˜¯å¦é€ƒé€¸ï¼Œå †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼Œåˆå§‹åŒ–å¤§å°é•¿åº¦ä¸8çš„å…³ç³»ç­‰ä½¿ç”¨ä¸åŒçš„åˆå§‹åŒ–é€»è¾‘ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯<code>makemap</code></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// makemap implements Go map creation for make(map[k]v, hint).
</span><span class="c1">// If the compiler has determined that the map or the first bucket
</span><span class="c1">// can be created on the stack, h and/or bucket may be non-nil.
</span><span class="c1">// If h != nil, the map can be created directly in h.
</span><span class="c1">// If h.buckets != nil, bucket pointed to can be used as the first bucket.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">makemap</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">hint</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="o">*</span><span class="nx">hmap</span> <span class="p">{</span>
	<span class="nx">mem</span><span class="p">,</span> <span class="nx">overflow</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nf">MulUintptr</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">hint</span><span class="p">),</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">overflow</span> <span class="o">||</span> <span class="nx">mem</span> <span class="p">&gt;</span> <span class="nx">maxAlloc</span> <span class="p">{</span>
		<span class="nx">hint</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="p">}</span>

	<span class="c1">// initialize Hmap
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">h</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">hmap</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span> <span class="p">=</span> <span class="nf">fastrand</span><span class="p">()</span>

	<span class="c1">// Find the size parameter B which will hold the requested # of elements.
</span><span class="c1"></span>	<span class="c1">// For hint &lt; 0 overLoadFactor returns false since hint &lt; bucketCnt.
</span><span class="c1"></span>	<span class="nx">B</span> <span class="o">:=</span> <span class="nb">uint8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">for</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">hint</span><span class="p">,</span> <span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">B</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">=</span> <span class="nx">B</span>

	<span class="c1">// allocate initial hash table
</span><span class="c1"></span>	<span class="c1">// if B == 0, the buckets field is allocated lazily later (in mapassign)
</span><span class="c1"></span>	<span class="c1">// If hint is large zeroing this memory could take a while.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">nextOverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mapextra</span><span class="p">)</span>
			<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nx">nextOverflow</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">h</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¼šåˆ†æˆä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>è®¡ç®—å“ˆå¸Œå ç”¨çš„å†…å­˜æ˜¯å¦æº¢å‡ºæˆ–è€…è¶…å‡ºèƒ½åˆ†é…çš„æœ€å¤§å€¼ï¼›</li>
<li>è°ƒç”¨ fastrand è·å–ä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­ï¼›</li>
<li>æ ¹æ®ä¼ å…¥çš„ hint è®¡ç®—å‡ºéœ€è¦çš„æœ€å°éœ€è¦çš„æ¡¶çš„æ•°é‡ï¼›</li>
<li>ä½¿ç”¨ runtime.makeBucketArray åˆ›å»ºç”¨äºä¿å­˜æ¡¶çš„æ•°ç»„ï¼›</li>
</ol>
<p><code>runtime.makeBucketArray</code> å‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„ B è®¡ç®—å‡ºçš„éœ€è¦åˆ›å»ºçš„æ¡¶æ•°é‡åœ¨å†…å­˜ä¸­åˆ†é…ä¸€ç‰‡è¿ç»­çš„ç©ºé—´ç”¨äºå­˜å‚¨æ•°æ®:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">uint8</span><span class="p">,</span> <span class="nx">dirtyalloc</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">buckets</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">base</span> <span class="o">:=</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
	<span class="nx">nbuckets</span> <span class="o">:=</span> <span class="nx">base</span>
	<span class="k">if</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="p">{</span>
		<span class="nx">nbuckets</span> <span class="o">+=</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
		<span class="nx">sz</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="nx">nbuckets</span>
		<span class="nx">up</span> <span class="o">:=</span> <span class="nf">roundupsize</span><span class="p">(</span><span class="nx">sz</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">up</span> <span class="o">!=</span> <span class="nx">sz</span> <span class="p">{</span>
			<span class="nx">nbuckets</span> <span class="p">=</span> <span class="nx">up</span> <span class="o">/</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">buckets</span> <span class="p">=</span> <span class="nf">newarray</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">nbuckets</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">base</span> <span class="o">!=</span> <span class="nx">nbuckets</span> <span class="p">{</span>
		<span class="nx">nextOverflow</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">base</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
		<span class="nx">last</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">nbuckets</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
		<span class="nx">last</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nx">buckets</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">buckets</span><span class="p">,</span> <span class="nx">nextOverflow</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><ul>
<li>å½“æ¡¶çš„æ•°é‡å°äº $2^4$ æ—¶ï¼Œç”±äºæ•°æ®è¾ƒå°‘ã€ä½¿ç”¨æº¢å‡ºæ¡¶çš„å¯èƒ½æ€§è¾ƒä½ï¼Œè¿™æ—¶å°±ä¼šçœç•¥åˆ›å»ºçš„è¿‡ç¨‹ä»¥å‡å°‘é¢å¤–å¼€é”€ï¼›</li>
<li>å½“æ¡¶çš„æ•°é‡å¤šäº $2^4$ æ—¶ï¼Œå°±ä¼šé¢å¤–åˆ›å»º $2^{ğµâˆ’4}$ ä¸ªæº¢å‡ºæ¡¶ï¼›</li>
</ul>
<p>æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬èƒ½ç¡®å®šåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œåªæ˜¯è¢«<code>hmap</code>ä¸­çš„ä¸åŒå­—æ®µå¼•ç”¨ï¼Œå½“æº¢å‡ºæ¡¶æ•°é‡è¾ƒå¤šæ—¶ä¼šé€šè¿‡<code>runtime.newobject</code>åˆ›å»ºæ–°çš„æº¢å‡ºæ¡¶ã€‚</p>
<h3 id="è®¿é—®map"><a href="#è®¿é—®map" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:è®¿é—®map" class="headings">è®¿é—®map</a></h3>
<p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨mapæœ‰2ç§æ–¹å¼</p>
<ol>
<li>é€šè¿‡key</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">v</span> <span class="o">:=</span> <span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
</code></pre></td></tr></table></div>
</div>
</div><p>åœ¨ç¼–è¯‘çš„ç±»å‹æ£€æŸ¥æœŸé—´ï¼Œhash[key] ä»¥åŠç±»ä¼¼çš„æ“ä½œéƒ½ä¼šè¢«è½¬æ¢æˆå¯¹å“ˆå¸Œçš„ OINDEXMAP æ“ä½œï¼Œä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µä¼šåœ¨ cmd/compile/internal/gc.walkexpr å‡½æ•°ä¸­å°†è¿™äº› OINDEXMAP æ“ä½œè½¬æ¢æˆå¦‚ä¸‹çš„ä»£ç ï¼š</p>
<pre><code>v     := hash[key] // =&gt; v     := *mapaccess1(maptype, hash, &amp;key)
v, ok := hash[key] // =&gt; v, ok := mapaccess2(maptype, hash, &amp;key)
</code></pre><p>èµ‹å€¼è¯­å¥å·¦ä¾§æ¥å—å‚æ•°çš„ä¸ªæ•°ä¼šå†³å®šä½¿ç”¨çš„è¿è¡Œæ—¶æ–¹æ³•ï¼š</p>
<ol>
<li>å½“æ¥å—å‚æ•°ä»…ä¸ºä¸€ä¸ªæ—¶ï¼Œä¼šä½¿ç”¨ runtime.mapaccess1ï¼Œè¯¥å‡½æ•°ä»…ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ç›®æ ‡å€¼çš„æŒ‡é’ˆï¼›</li>
<li>å½“æ¥å—ä¸¤ä¸ªå‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨ runtime.mapaccess2ï¼Œé™¤äº†è¿”å›ç›®æ ‡å€¼ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šè¿”å›ä¸€ä¸ªç”¨äºè¡¨ç¤ºå½“å‰é”®å¯¹åº”çš„å€¼æ˜¯å¦å­˜åœ¨çš„å¸ƒå°”å€¼</li>
</ol>
<p><code>runtime.mapaccess1</code> å‡½æ•°ä¼šå…ˆé€šè¿‡å“ˆå¸Œè¡¨è®¾ç½®çš„å“ˆå¸Œå‡½æ•°ã€ç§å­è·å–å½“å‰é”®å¯¹åº”çš„å“ˆå¸Œï¼Œå†é€šè¿‡ bucketMask å’Œ add å‡½æ•°æ‹¿åˆ°è¯¥é”®å€¼å¯¹æ‰€åœ¨çš„æ¡¶åºå·å’Œå“ˆå¸Œæœ€ä¸Šé¢çš„ 8 ä½æ•°å­—ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapaccess1</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>  <span class="c1">// æ£€æµ‹æ˜¯å¦å¹¶å‘å†™ï¼Œmapä¸æ˜¯gorountineå®‰å…¨çš„
</span><span class="c1"></span>		<span class="nf">throw</span><span class="p">(</span><span class="s">&#34;concurrent map read and map write&#34;</span><span class="p">)</span>
	<span class="p">}</span>
  <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span> 
	<span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
  <span class="c1">// å¦‚æœè€çš„bucketæ²¡æœ‰è¢«ç§»åŠ¨å®Œï¼Œé‚£ä¹ˆå»è€çš„bucketä¸­å¯»æ‰¾
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
			<span class="c1">// There used to be half as many buckets; mask down one more power of two.
</span><span class="c1"></span>			<span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
		<span class="p">}</span>
		<span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>
		<span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// å¯»æ‰¾è¿‡ç¨‹ï¼šä¸æ–­æ¯”å¯¹tophashå’Œkey
</span><span class="c1"></span>	<span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
<span class="nx">bucketloop</span><span class="p">:</span>
	<span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
					<span class="k">break</span> <span class="nx">bucketloop</span>
				<span class="p">}</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
			<span class="k">if</span> <span class="nx">alg</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">v</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">valuesize</span><span class="p">))</span>
				<span class="k">return</span> <span class="nx">v</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>åœ¨ bucketloop å¾ªç¯ä¸­ï¼Œå“ˆå¸Œä¼šä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­çš„æ•°æ®ï¼Œå®ƒä¼šæ¯”è¾ƒè¿™ 8 ä½æ•°å­—å’Œæ¡¶ä¸­å­˜å‚¨çš„ tophashï¼Œæ¯ä¸€ä¸ªæ¡¶éƒ½å­˜å‚¨é”®å¯¹åº”çš„ tophashï¼Œæ¯ä¸€æ¬¡è¯»å†™æ“ä½œéƒ½ä¼šä¸æ¡¶ä¸­æ‰€æœ‰çš„ tophash è¿›è¡Œæ¯”è¾ƒï¼Œç”¨äºé€‰æ‹©æ¡¶åºå·çš„æ˜¯å“ˆå¸Œçš„æœ€ä½å‡ ä½ï¼Œè€Œç”¨äºåŠ é€Ÿè®¿é—®çš„æ˜¯å“ˆå¸Œçš„é«˜ 8 ä½ï¼Œè¿™ç§è®¾è®¡èƒ½å¤Ÿå‡å°‘åŒä¸€ä¸ªæ¡¶ä¸­æœ‰å¤§é‡ç›¸ç­‰ tophash çš„æ¦‚ç‡ã€‚</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/%E8%AE%BF%E9%97%AEmap.png" alt="è®¿é—®map"></p>
<ol start="2">
<li>ä½¿ç”¨for rangeéå†map</li>
</ol>
<p>åœ¨éå†å“ˆå¸Œè¡¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨<code>runtime.mapiterinit</code>å’Œ<code>runtime.mapiternext</code>ä¸¤ä¸ªè¿è¡Œæ—¶å‡½æ•°é‡å†™åŸå§‹çš„ for range å¾ªç¯ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">ha</span> <span class="o">:=</span> <span class="nx">a</span>
<span class="nx">hit</span> <span class="o">:=</span> <span class="nf">hiter</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
<span class="nx">th</span> <span class="o">:=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">Type</span>
<span class="nf">mapiterinit</span><span class="p">(</span><span class="nf">typename</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hit</span><span class="p">)</span>
<span class="k">for</span> <span class="p">;</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">key</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hit</span><span class="p">.</span><span class="nx">key</span>
    <span class="nx">val</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hit</span><span class="p">.</span><span class="nx">val</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ä¸Šè¿°ä»£ç æ˜¯ <code>for key, val := range hash {}</code> ç”Ÿæˆçš„ï¼Œåœ¨ <code>cmd/compile/internal/gc.walkrange</code> å‡½æ•°å¤„ç† <code>TMAP</code> èŠ‚ç‚¹æ—¶ä¼šæ ¹æ®æ¥å— range è¿”å›å€¼çš„æ•°é‡åœ¨å¾ªç¯ä½“ä¸­æ’å…¥éœ€è¦çš„èµ‹å€¼è¯­å¥ï¼š</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/range%E9%81%8D%E5%8E%86map.png" alt="è®¿é—®map"></p>
<p>è¿™ä¸‰ç§ä¸åŒçš„æƒ…å†µä¼šåˆ†åˆ«å‘å¾ªç¯ä½“æ’å…¥ä¸åŒçš„èµ‹å€¼è¯­å¥ã€‚éå†å“ˆå¸Œè¡¨æ—¶ä¼šä½¿ç”¨ runtime.mapiterinit å‡½æ•°åˆå§‹åŒ–éå†å¼€å§‹çš„å…ƒç´ ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapiterinit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">t</span> <span class="p">=</span> <span class="nx">t</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">h</span> <span class="p">=</span> <span class="nx">h</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">B</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span>

	<span class="nx">r</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">())</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="p">=</span> <span class="nx">r</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">offset</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">r</span> <span class="o">&gt;&gt;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
	<span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span>
	<span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>è¯¥å‡½æ•°ä¼šåˆå§‹åŒ– hiter ç»“æ„ä½“ä¸­çš„å­—æ®µï¼Œå¹¶é€šè¿‡ runtime.fastrand ç”Ÿæˆä¸€ä¸ªéšæœºæ•°å¸®åŠ©æˆ‘ä»¬éšæœºé€‰æ‹©ä¸€ä¸ªæ¡¶å¼€å§‹éå†ã€‚Go å›¢é˜Ÿåœ¨è®¾è®¡å“ˆå¸Œè¡¨çš„éå†æ—¶å°±ä¸æƒ³è®©ä½¿ç”¨è€…ä¾èµ–å›ºå®šçš„éå†é¡ºåºï¼Œæ‰€ä»¥å¼•å…¥äº†éšæœºæ•°ä¿è¯éå†çš„éšæœºæ€§ã€‚</p>
<p>éå†å“ˆå¸Œä¼šä½¿ç”¨ runtime.mapiternext å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œç®€åŒ–äº†å¾ˆå¤šé€»è¾‘ï¼Œçœå»äº†ä¸€äº›è¾¹ç•Œæ¡ä»¶ä»¥åŠå“ˆå¸Œè¡¨æ‰©å®¹æ—¶çš„å…¼å®¹æ“ä½œï¼Œè¿™é‡Œåªéœ€è¦å…³æ³¨å¤„ç†éå†é€»è¾‘çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬ä¼šå°†è¯¥å‡½æ•°åˆ†æˆæ¡¶çš„é€‰æ‹©å’Œæ¡¶å†…å…ƒç´ çš„éå†ä¸¤éƒ¨åˆ†è¿›è¡Œåˆ†æï¼Œé¦–å…ˆæ˜¯æ¡¶çš„é€‰æ‹©è¿‡ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">h</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">h</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">t</span>
	<span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span>
	<span class="nx">b</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span>
	<span class="nx">i</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">i</span>
	<span class="nx">alg</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">alg</span>

<span class="nx">next</span><span class="p">:</span>
	<span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="o">&amp;&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">{</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
		<span class="nx">bucket</span><span class="o">++</span>
		<span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">bucket</span> <span class="p">=</span> <span class="mi">0</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="p">}</span>
		<span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>è¿™æ®µä»£ç ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ol>
<li>åœ¨å¾…éå†çš„æ¡¶ä¸ºç©ºæ—¶é€‰æ‹©éœ€è¦éå†çš„æ–°æ¡¶ï¼›</li>
<li>åœ¨ä¸å­˜åœ¨å¾…éå†çš„æ¡¶æ—¶è¿”å› (nil, nil) é”®å€¼å¯¹å¹¶ä¸­æ­¢éå†è¿‡ç¨‹ï¼›</li>
</ol>
<p>runtime.mapiternext å‡½æ•°ä¸­ç¬¬äºŒæ®µä»£ç çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä»æ¡¶ä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªéå†çš„å…ƒç´ ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šç›´æ¥æ“ä½œå†…å­˜è·å–ç›®æ ‡é”®å€¼çš„å†…å­˜åœ°å€ï¼Œä¸è¿‡å¦‚æœå“ˆå¸Œè¡¨å¤„äºæ‰©å®¹æœŸé—´å°±ä¼šè°ƒç”¨ runtime.mapaccessK å‡½æ•°è·å–é”®å€¼å¯¹ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="k">for</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">offi</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">it</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
		<span class="nx">v</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">valuesize</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedX</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedY</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">!(</span><span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">||</span> <span class="nx">alg</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">k</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">v</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">rk</span><span class="p">,</span> <span class="nx">rv</span> <span class="o">:=</span> <span class="nf">mapaccessK</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">rk</span>
			<span class="nx">it</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">rv</span>
		<span class="p">}</span>
		<span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">bucket</span>
		<span class="nx">it</span><span class="p">.</span><span class="nx">i</span> <span class="p">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="k">goto</span> <span class="nx">next</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å½“ä¸Šè¿°å‡½æ•°å·²ç»éå†äº†æ­£å¸¸æ¡¶ï¼Œå°±ä¼šé€šè¿‡<code>runtime.bmap.overflow</code>è·å–æº¢å‡ºæ¡¶ä¾æ¬¡è¿›è¡Œéå†ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹å“ˆå¸Œè¡¨éå†çš„é¡ºåºï¼Œé¦–å…ˆä¼šé€‰å‡ºä¸€ä¸ªæ­£å¸¸æ¡¶å¼€å§‹éå†ï¼Œéšåéå†å¯¹åº”çš„æ‰€æœ‰æº¢å‡ºæ¡¶ï¼Œæœ€åä¾æ¬¡æŒ‰ç…§ç´¢å¼•é¡ºåºéå†å“ˆå¸Œè¡¨ä¸­å…¶ä»–çš„æ¡¶ï¼Œç›´åˆ°æ‰€æœ‰çš„æ¡¶éƒ½è¢«éå†å®Œæˆã€‚</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/map%E9%81%8D%E5%8E%86.png" alt="mapéå†"></p>
<h3 id="å†™å…¥map"><a href="#å†™å…¥map" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:å†™å…¥map" class="headings">å†™å…¥map</a></h3>
<p>åœ¨<code>cmd/compile/internal/gc/walk.go#walkexpr</code>æ–¹æ³•çš„<code>OINDEXMAP</code>åˆ†æ”¯ä¸­</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nf">IndexMapLValue</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// This m[k] expression is on the left-hand side of an assignment.
</span><span class="c1"></span>  <span class="nx">fast</span> <span class="o">:=</span> <span class="nf">mapfast</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">fast</span> <span class="o">==</span> <span class="nx">mapslow</span> <span class="p">{</span>
    <span class="c1">// standard version takes key by reference.
</span><span class="c1"></span>    <span class="c1">// order.expr made sure key is addressable.
</span><span class="c1"></span>    <span class="nx">key</span> <span class="p">=</span> <span class="nf">nod</span><span class="p">(</span><span class="nx">OADDR</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">n</span> <span class="p">=</span> <span class="nf">mkcall1</span><span class="p">(</span><span class="nf">mapfn</span><span class="p">(</span><span class="nx">mapassign</span><span class="p">[</span><span class="nx">fast</span><span class="p">],</span> <span class="nx">t</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="nf">typename</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">map_</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="p">}</span> 
</code></pre></td></tr></table></div>
</div>
</div><p>å½“m[k]å®åœ¨èµ‹å€¼çš„å·¦è¾¹æ—¶ï¼Œä¼šè½¬æ¢æˆ<code>runtime.mapassign</code>å‡½æ•°çš„è°ƒç”¨ï¼›é¦–å…ˆæ˜¯å‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„é”®æ‹¿åˆ°å¯¹åº”çš„å“ˆå¸Œå’Œæ¡¶</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapassign</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>

  <span class="c1">// Set hashWriting after calling t.hasher, since t.hasher may panic,
</span><span class="c1"></span>  <span class="c1">// in which case we have not actually done a write.
</span><span class="c1"></span>  <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">^=</span> <span class="nx">hashWriting</span>

<span class="nx">again</span><span class="p">:</span>
  <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">)</span> <span class="o">+</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
  <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ç„¶åé€šè¿‡éå†æ¯”è¾ƒæ¡¶ä¸­å­˜å‚¨çš„ tophash å’Œé”®çš„å“ˆå¸Œï¼Œå¦‚æœæ‰¾åˆ°äº†ç›¸åŒç»“æœå°±ä¼šè¿”å›ç›®æ ‡ä½ç½®çš„åœ°å€ã€‚å…¶ä¸­ inserti è¡¨ç¤ºç›®æ ‡å…ƒç´ çš„åœ¨æ¡¶ä¸­çš„ç´¢å¼•ï¼Œinsertk å’Œ elem åˆ†åˆ«è¡¨ç¤ºé”®å€¼å¯¹çš„åœ°å€ï¼Œè·å¾—ç›®æ ‡åœ°å€ä¹‹åä¼šé€šè¿‡ç®—æœ¯è®¡ç®—å¯»å€è·å¾—é”®å€¼å¯¹ k å’Œ elem:</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="kd">var</span> <span class="nx">inserti</span> <span class="o">*</span><span class="kt">uint8</span>
	<span class="kd">var</span> <span class="nx">insertk</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
	<span class="kd">var</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
<span class="nx">bucketloop</span><span class="p">:</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="c1">// éå† 8 ä¸ª bucket ä¸­çš„å…ƒç´ 
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">inserti</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="c1">// å¦‚æœè¿™ä¸ªæ§½ä½æ²¡æœ‰è¢«å ï¼Œè¯´æ˜å¯ä»¥å¾€è¿™é‡Œå¡ key å’Œ value
</span><span class="c1"></span>          <span class="nx">inserti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>  <span class="c1">// tophash çš„æ’å…¥ä½ç½®
</span><span class="c1"></span>          <span class="nx">insertk</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
          <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
          <span class="k">break</span> <span class="nx">bucketloop</span>
        <span class="p">}</span>
        <span class="k">continue</span>
      <span class="p">}</span>
      <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="c1">// å¦‚æœç›¸åŒçš„ hash ä½ç½®çš„ key å’Œè¦æ’å…¥çš„ key å­—é¢ä¸Šä¸ç›¸ç­‰
</span><span class="c1"></span>      <span class="c1">// å¦‚æœä¸¤ä¸ª key çš„é¦–å…«ä½åæœ€åå…«ä½å“ˆå¸Œå€¼ä¸€æ ·ï¼Œå°±ä¼šè¿›è¡Œå…¶å€¼æ¯”è¾ƒ
</span><span class="c1"></span>      <span class="c1">// ç®—æ˜¯ä¸€ç§å“ˆå¸Œç¢°æ’å§ 
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span>
      <span class="p">}</span>
      <span class="c1">// already have a mapping for key. Update it.
</span><span class="c1"></span>      <span class="c1">// å¯¹åº”çš„ä½ç½®å·²ç»æœ‰ key äº†ï¼Œç›´æ¥æ›´æ–°å°±è¡Œ
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">needkeyupdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
      <span class="k">goto</span> <span class="nx">done</span>
    <span class="p">}</span>
    <span class="c1">// bucket çš„ 8 ä¸ªæ§½æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èƒ½æ’å…¥æˆ–è€…èƒ½æ›´æ–°çš„ï¼Œå» overflow é‡Œç»§ç»­æ‰¾
</span><span class="c1"></span>    <span class="nx">ovf</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="c1">// å¦‚æœ overflow ä¸º nilï¼Œè¯´æ˜åˆ°äº† overflow é“¾è¡¨çš„æœ«ç«¯äº†
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">ovf</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="nx">ovf</span>
  <span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ä¸Šè¿°çš„ for å¾ªç¯ä¼šä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­å­˜å‚¨çš„æ•°æ®ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šåˆ†åˆ«åˆ¤æ–­ tophash æ˜¯å¦ç›¸ç­‰ã€key æ˜¯å¦ç›¸ç­‰ï¼Œéå†ç»“æŸåä¼šä»å¾ªç¯ä¸­è·³å‡ºã€‚</p>
<p>å¦‚æœå½“å‰æ¡¶å·²ç»æ»¡äº†ï¼Œå“ˆå¸Œä¼šè°ƒç”¨<code>runtime.hmap.newoverflow</code>åˆ›å»ºæ–°æ¡¶æˆ–è€…ä½¿ç”¨<code>runtime.hmap</code>é¢„å…ˆåœ¨noverflowä¸­åˆ›å»ºå¥½çš„æ¡¶æ¥ä¿å­˜æ•°æ®ï¼Œæ–°åˆ›å»ºçš„æ¡¶ä¸ä»…ä¼šè¢«è¿½åŠ åˆ°å·²æœ‰æ¡¶çš„æœ«å°¾ï¼Œè¿˜ä¼šå¢åŠ å“ˆå¸Œè¡¨çš„ noverflow è®¡æ•°å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="k">if</span> <span class="nx">inserti</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// The current bucket and all the overflow buckets connected to it are full, allocate a new one.
</span><span class="c1"></span>    <span class="c1">// å‰é¢åœ¨æ¡¶é‡Œæ‰¾çš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°èƒ½å¡è¿™ä¸ª tophash çš„ä½ç½®
</span><span class="c1"></span>    <span class="c1">// è¯´æ˜å½“å‰æ‰€æœ‰ buckets éƒ½æ˜¯æ»¡çš„ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„ bucket
</span><span class="c1"></span>    <span class="nx">newb</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
    <span class="nx">inserti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">newb</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">insertk</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newb</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
    <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">insertk</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="c1">// store new key/elem at insert position
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">kmem</span> <span class="o">:=</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">insertk</span><span class="p">)</span> <span class="p">=</span> <span class="nx">kmem</span>
    <span class="nx">insertk</span> <span class="p">=</span> <span class="nx">kmem</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">vmem</span> <span class="o">:=</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">=</span> <span class="nx">vmem</span>
  <span class="p">}</span>

  <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">insertk</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="o">*</span><span class="nx">inserti</span> <span class="p">=</span> <span class="nx">top</span>
  <span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å¦‚æœå½“å‰é”®å€¼å¯¹åœ¨å“ˆå¸Œä¸­ä¸å­˜åœ¨ï¼Œå“ˆå¸Œä¼šä¸ºæ–°é”®å€¼å¯¹è§„åˆ’å­˜å‚¨çš„å†…å­˜åœ°å€ï¼Œé€šè¿‡<code>runtime.typedmemmove</code>å°†é”®ç§»åŠ¨åˆ°å¯¹åº”çš„å†…å­˜ç©ºé—´ä¸­å¹¶è¿”å›é”®å¯¹åº”å€¼çš„åœ°å€ valã€‚å¦‚æœå½“å‰é”®å€¼å¯¹åœ¨å“ˆå¸Œä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›ç›®æ ‡åŒºåŸŸçš„å†…å­˜åœ°å€ï¼Œå“ˆå¸Œå¹¶ä¸ä¼šåœ¨<code>runtime.mapassign</code>è¿™ä¸ªè¿è¡Œæ—¶å‡½æ•°ä¸­å°†å€¼æ‹·è´åˆ°æ¡¶ä¸­ï¼Œè¯¥å‡½æ•°åªä¼šè¿”å›å†…å­˜åœ°å€ï¼ŒçœŸæ­£çš„èµ‹å€¼æ“ä½œæ˜¯åœ¨ç¼–è¯‘æœŸé—´æ’å…¥çš„ï¼š</p>
<pre><code>00018 (+5) CALL runtime.mapassign_fast64(SB)
00020 (5) MOVQ 24(SP), DI               ;; DI = &amp;value
00026 (5) LEAQ go.string.&quot;88&quot;(SB), AX   ;; AX = &amp;&quot;88&quot;
00027 (5) MOVQ AX, (DI)                 ;; *DI = AX
</code></pre><p>èµ‹å€¼çš„æœ€åä¸€æ­¥å®é™…ä¸Šæ˜¯ç¼–è¯‘å™¨é¢å¤–ç”Ÿæˆçš„æ±‡ç¼–æŒ‡ä»¤æ¥å®Œæˆçš„ï¼Œå¯è§é  runtime æœ‰äº›å·¥ä½œæ˜¯æ²¡æœ‰åšå®Œçš„ã€‚è¿™é‡Œå’Œ go åœ¨å‡½æ•°è°ƒç”¨æ—¶æ’å…¥ prologue å’Œ epilogue æ˜¯ç±»ä¼¼çš„ã€‚ç¼–è¯‘å™¨å’Œ runtime é…åˆï¼Œæ‰èƒ½å®Œæˆä¸€äº›å¤æ‚çš„å·¥ä½œã€‚</p>
<h3 id="mapæ‰©å®¹"><a href="#mapæ‰©å®¹" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:mapæ‰©å®¹" class="headings">mapæ‰©å®¹</a></h3>
<p>åœ¨<code>mapassign</code>ä¸­è¿˜æœ‰ä¸€æ®µå…³äºæ‰©å®¹çš„é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// If we hit the max load factor or we have too many overflow buckets,
</span><span class="c1">// and we&#39;re not already in the middle of growing, start growing.
</span><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="o">||</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">))</span> <span class="p">{</span>
  <span class="nf">hashGrow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
  <span class="k">goto</span> <span class="nx">again</span> <span class="c1">// Growing the table invalidates everything, so try again
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// overLoadFactor reports whether count items placed in 1&lt;&lt;B buckets is over loadFactor.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">count</span> <span class="p">&gt;</span> <span class="nx">bucketCnt</span> <span class="o">&amp;&amp;</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">loadFactorNum</span><span class="o">*</span><span class="p">(</span><span class="nf">bucketShift</span><span class="p">(</span><span class="nx">B</span><span class="p">)</span><span class="o">/</span><span class="nx">loadFactorDen</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1&lt;&lt;B buckets.
</span><span class="c1">// Note that most of these overflow buckets must be in sparse use;
</span><span class="c1">// if use was dense, then we&#39;d have already triggered regular map growth.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">noverflow</span> <span class="kt">uint16</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="c1">// If the threshold is too low, we do extraneous work.
</span><span class="c1"></span>  <span class="c1">// If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory.
</span><span class="c1"></span>  <span class="c1">// &#34;too many&#34; means (approximately) as many overflow buckets as regular buckets.
</span><span class="c1"></span>  <span class="c1">// See incrnoverflow for more details.
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">B</span> <span class="p">&gt;</span> <span class="mi">15</span> <span class="p">{</span>
    <span class="nx">B</span> <span class="p">=</span> <span class="mi">15</span>
  <span class="p">}</span>
  <span class="c1">// The compiler doesn&#39;t see here that B &lt; 16; mask B to generate shorter shift code.
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">noverflow</span> <span class="o">&gt;=</span> <span class="nb">uint16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">B</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å¯ä»¥çœ‹åˆ°æœ‰2ç§æ¡ä»¶ä¼šè§¦å‘æ‰©å®¹</p>
<ol>
<li>æ˜¯ä¸æ˜¯å·²ç»åˆ°äº† load factor çš„ä¸´ç•Œç‚¹ï¼Œå³å…ƒç´ ä¸ªæ•° &gt;= æ¡¶ä¸ªæ•° * 6.5ï¼Œè¿™æ—¶å€™è¯´æ˜å¤§éƒ¨åˆ†çš„æ¡¶å¯èƒ½éƒ½å¿«æ»¡äº†ï¼Œå¦‚æœæ’å…¥æ–°å…ƒç´ ï¼Œæœ‰å¤§æ¦‚ç‡éœ€è¦æŒ‚åœ¨ overflow çš„æ¡¶ä¸Š</li>
<li>overflow çš„æ¡¶æ˜¯ä¸æ˜¯å¤ªå¤šäº†ï¼Œå½“ bucket æ€»æ•° &lt; 2 ^ 15 æ—¶ï¼Œå¦‚æœ overflow çš„ bucket æ€»æ•° &gt;= bucket çš„æ€»æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸º overflow çš„æ¡¶å¤ªå¤šäº†ã€‚å½“ bucket æ€»æ•° &gt;= 2 ^ 15 æ—¶ï¼Œé‚£æˆ‘ä»¬ç›´æ¥å’Œ 2 ^ 15 æ¯”è¾ƒï¼Œoverflow çš„ bucket &gt;= 2 ^ 15 æ—¶ï¼Œå³è®¤ä¸ºæº¢å‡ºæ¡¶å¤ªå¤šäº†ã€‚ä¸ºå•¥ä¼šå¯¼è‡´è¿™ç§æƒ…å†µå‘¢ï¼Ÿæ˜¯å› ä¸ºæˆ‘ä»¬å¯¹ map ä¸€è¾¹æ’å…¥ï¼Œä¸€è¾¹åˆ é™¤ï¼Œä¼šå¯¼è‡´å…¶ä¸­å¾ˆå¤šæ¡¶å‡ºç°ç©ºæ´ï¼Œè¿™æ ·ä½¿å¾— bucket ä½¿ç”¨ç‡ä¸é«˜ï¼Œå€¼å­˜å‚¨å¾—æ¯”è¾ƒç¨€ç–ã€‚åœ¨æŸ¥æ‰¾æ—¶æ•ˆç‡ä¼šä¸‹é™</li>
</ol>
<p>å¯¹äºç¬¬2ç‚¹æˆ‘åœ¨çœ‹å…¶ä»–å¤§ä½¬çš„åšå®¢æ—¶æœ‰ç‚¹è¿·æƒ‘ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ç†è§£ï¼Œå¯èƒ½ä¸å¤ªæ­£ç¡®</p>
<p>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç° overflow çš„ bucket æ€»æ•° &gt;= bucket çš„æ€»æ•°ï¼Ÿ</p>
<p>çœ‹äº†å‰é¢<code>mapassign</code>çš„è¿‡ç¨‹ï¼Œåœ¨mapä¸­æ’å…¥å€¼çš„æ—¶å€™ä¼šå…ˆåœ¨æ­£å¸¸æ¡¶ä¸­æ‰¾åˆ°ç©ºä½ç½®ï¼Œè€Œä¸”å°½é‡æ‰¾é å‰çš„ç©ºä½ç½®ï¼Œåªæœ‰æ­£å¸¸æ¡¶çš„8ä¸ªä½ç½®éƒ½æ»¡äº†ä¹‹åæ‰ä¼šåˆ›å»ºæ–°çš„overflowæ¡¶ï¼Œè€Œä¸”æœ‰æ¡ä»¶1çš„å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯å…ƒç´ ä¸ªæ•° &gt;= æ¡¶ä¸ªæ•° * 6.5ä¼šè§¦å‘æ‰©å®¹ï¼Œåœ¨ä»¥ä¸Šæ¡ä»¶ä¸‹ï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºç°overflow çš„ bucket æ€»æ•° &gt;= bucket çš„æ€»æ•°ï¼Ÿ</p>
<p>åœ¨Dravenesså¤§ä½¬çš„åšå®¢ä¸­<a href="https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-hashmap/#%E6%89%A9%E5%AE%B9" target="_blank" rel="noopener">å…³äºæ‰©å®¹è¿™æ®µ</a>ä¸­æåˆ°äº†ä¸€ä¸ª<a href="https://github.com/golang/go/issues/16070" target="_blank" rel="noopener">issue</a>ï¼Œåœ¨è¿™ä¸ªissueä¸­ç»™å‡ºäº†ä¸€æ®µä½¿ç”¨mapçš„ä»£ç ï¼Œå¤§æ¦‚å°±æ˜¯åœ¨mapä¸­éšæœºæ·»åŠ ä¸€äº›å€¼ï¼Œç„¶ååˆéšæœºåˆ é™¤(æºä»£ç ä¸­å¹¶ä¸æ˜¯éšæœºåˆ é™¤çš„ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ·»åŠ å®Œåç«‹å³åˆ é™¤ï¼Œæ‰€ä»¥æˆ‘å°±ç†è§£æˆéšæœºåˆ é™¤äº†)ï¼Œæœ€åå‘ç°mapå ç”¨çš„ç©ºé—´ä¼šè¶Šæ¥è¶Šå¤§(ä¹Ÿå°±æ˜¯å†…å­˜æ³„æ¼)ï¼Œå…¶å®è¿™ä¸ªé—®é¢˜å°±å›ç­”äº†å‰é¢çš„ç–‘é—®</p>
<p>å†åˆ†æä¸€ä¸‹åŸå› ï¼šä¸åœåœ°æ’å…¥ã€åˆ é™¤å…ƒç´ ã€‚å…ˆæ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºäº†å¾ˆå¤š bucketï¼Œä½†æ˜¯è£…è½½å› å­è¾¾ä¸åˆ°ç¬¬ 1 ç‚¹çš„ä¸´ç•Œå€¼ï¼Œæœªè§¦å‘æ‰©å®¹æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚ä¹‹åï¼Œåˆ é™¤å…ƒç´ é™ä½å…ƒç´ æ€»æ•°é‡ï¼Œå†æ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºå¾ˆå¤šçš„ overflow bucketï¼Œä½†å°±æ˜¯ä¸ä¼šè§¦çŠ¯ç¬¬ 1 ç‚¹çš„è§„å®šï¼Œä½ èƒ½æ‹¿æˆ‘æ€ä¹ˆåŠï¼Ÿoverflow bucket æ•°é‡å¤ªå¤šï¼Œå¯¼è‡´ key ä¼šå¾ˆåˆ†æ•£ï¼ŒæŸ¥æ‰¾æ’å…¥æ•ˆç‡ä½å¾—å“äººï¼Œå› æ­¤å‡ºå°ç¬¬ 2 ç‚¹è§„å®šã€‚è¿™å°±åƒæ˜¯ä¸€åº§ç©ºåŸï¼Œæˆ¿å­å¾ˆå¤šï¼Œä½†æ˜¯ä½æˆ·å¾ˆå°‘ï¼Œéƒ½åˆ†æ•£äº†ï¼Œæ‰¾èµ·äººæ¥å¾ˆå›°éš¾ã€‚</p>
<p>ä¸ºä»€ä¹ˆkeyå¾ˆåˆ†æ•£ï¼ŒæŸ¥æ‰¾æ’å…¥æ•ˆç‡ä½å¾—å“äººï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œå¯èƒ½æˆ‘å½“æ—¶è„‘å­è½¬ä¸è¿‡å¼¯äº†ã€‚æŸ¥æ‰¾å’Œæ’å…¥éƒ½ä¼šå®šä½åˆ°ä¸€ä¸ªæ­£å¸¸æ¡¶ï¼Œå¦‚æœå‡ºç°å‰é¢è¯´çš„ï¼Œä¸åœæ’å…¥ã€åˆ é™¤å¯¼è‡´keyå¾ˆåˆ†æ•£ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ­£å¸¸æ¡¶åé¢é“¾ç€å¾ˆå¤šçš„overflowæ¡¶ï¼Œè¿™æ—¶å€™ä½ æŸ¥æ‰¾å’Œæ’å…¥æ‰¾ä½ç½®çš„æ—¶å€™å°±éœ€è¦éå†è¿™æ¡bucketé“¾ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šé™ä½ã€‚</p>
<p>æ‰€ä»¥å¯¹äºå‘½ä¸­æ¡ä»¶ 1ï¼Œ2 çš„é™åˆ¶ï¼Œéƒ½ä¼šå‘ç”Ÿæ‰©å®¹ã€‚ä½†æ˜¯æ‰©å®¹çš„ç­–ç•¥å¹¶ä¸ç›¸åŒï¼š</p>
<ul>
<li>å¯¹äºæ¡ä»¶ 1ï¼Œå…ƒç´ å¤ªå¤šï¼Œè€Œ bucket æ•°é‡å¤ªå°‘ï¼Œå¾ˆç®€å•ï¼šå°† B åŠ  1ï¼Œbucket æœ€å¤§æ•°é‡ï¼ˆ2^Bï¼‰ç›´æ¥å˜æˆåŸæ¥ bucket æ•°é‡çš„ 2 å€ã€‚äºæ˜¯ï¼Œå°±æœ‰æ–°è€ bucket äº†ã€‚æ³¨æ„ï¼Œè¿™æ—¶å€™å…ƒç´ éƒ½åœ¨è€ bucket é‡Œï¼Œè¿˜æ²¡è¿ç§»åˆ°æ–°çš„ bucket æ¥ã€‚è€Œä¸”ï¼Œæ–° bucket åªæ˜¯æœ€å¤§æ•°é‡å˜ä¸ºåŸæ¥æœ€å¤§æ•°é‡ï¼ˆ2^Bï¼‰çš„ 2 å€ï¼ˆ2^B * 2ï¼‰</li>
<li>å¯¹äºæ¡ä»¶ 2ï¼Œå…¶å®å…ƒç´ æ²¡é‚£ä¹ˆå¤šï¼Œä½†æ˜¯ overflow bucket æ•°ç‰¹åˆ«å¤šï¼Œè¯´æ˜å¾ˆå¤š bucket éƒ½æ²¡è£…æ»¡ã€‚è§£å†³åŠæ³•å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªæ–° bucket ç©ºé—´ï¼Œå°†è€ bucket ä¸­çš„å…ƒç´ ç§»åŠ¨åˆ°æ–° bucketï¼Œä½¿å¾—åŒä¸€ä¸ª bucket ä¸­çš„ key æ’åˆ—åœ°æ›´ç´§å¯†ã€‚è¿™æ ·ï¼ŒåŸæ¥ï¼Œåœ¨ overflow bucket ä¸­çš„ key å¯ä»¥ç§»åŠ¨åˆ° bucket ä¸­æ¥ã€‚ç»“æœæ˜¯èŠ‚çœç©ºé—´ï¼Œæé«˜ bucket åˆ©ç”¨ç‡ï¼Œmap çš„æŸ¥æ‰¾å’Œæ’å…¥æ•ˆç‡è‡ªç„¶å°±ä¼šæå‡</li>
</ul>
<p>æ‰©å®¹çš„å…¥å£æ˜¯<code>runtime.hashGrow</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">hashGrow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// B+1 ç›¸å½“äºæ˜¯åŸæ¥ 2 å€çš„ç©ºé—´
</span><span class="c1"></span>  <span class="nx">bigger</span> <span class="o">:=</span> <span class="nb">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="c1">// å¯¹åº”æ¡ä»¶ 2
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è¿›è¡Œç­‰é‡çš„å†…å­˜æ‰©å®¹ï¼Œæ‰€ä»¥ B ä¸å˜
</span><span class="c1"></span>		<span class="nx">bigger</span> <span class="p">=</span> <span class="mi">0</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">sameSizeGrow</span>
  <span class="p">}</span>
  <span class="c1">// å°†è€ buckets æŒ‚åˆ° buckets ä¸Š
</span><span class="c1"></span>  <span class="nx">oldbuckets</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span>
  <span class="c1">// ç”³è¯·æ–°çš„ buckets ç©ºé—´
</span><span class="c1"></span>	<span class="nx">newbuckets</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="o">:=</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="o">+</span><span class="nx">bigger</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>

  <span class="c1">// æäº¤ grow çš„åŠ¨ä½œ
</span><span class="c1"></span>	<span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">+=</span> <span class="nx">bigger</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">=</span> <span class="nx">flags</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span> <span class="p">=</span> <span class="nx">oldbuckets</span>
  <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nx">newbuckets</span>
  <span class="c1">// æ¬è¿è¿›åº¦ä¸º 0
</span><span class="c1"></span>  <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="p">=</span> <span class="mi">0</span>
  <span class="c1">// overflow buckets æ•°ä¸º 0
</span><span class="c1"></span>	<span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span> <span class="p">=</span> <span class="mi">0</span>

	<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nx">nextOverflow</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å“ˆå¸Œåœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ä¼šé€šè¿‡ runtime.makeBucketArray åˆ›å»ºä¸€ç»„æ–°æ¡¶å’Œé¢„åˆ›å»ºçš„æº¢å‡ºæ¡¶ï¼Œéšåå°†åŸæœ‰çš„æ¡¶æ•°ç»„è®¾ç½®åˆ° oldbuckets ä¸Šå¹¶å°†æ–°çš„ç©ºæ¡¶è®¾ç½®åˆ° buckets ä¸Šï¼Œæº¢å‡ºæ¡¶ä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„é€»è¾‘æ›´æ–°</p>
<p>æˆ‘ä»¬åœ¨<code>runtime.hashGrow</code>ä¸­è¿˜çœ‹ä¸å‡ºæ¥ç­‰é‡æ‰©å®¹å’Œç¿»å€æ‰©å®¹çš„å¤ªå¤šåŒºåˆ«ï¼Œç­‰é‡æ‰©å®¹åˆ›å»ºçš„æ–°æ¡¶æ•°é‡åªæ˜¯å’Œæ—§æ¡¶ä¸€æ ·ï¼Œè¯¥å‡½æ•°ä¸­åªæ˜¯åˆ›å»ºäº†æ–°çš„æ¡¶ï¼Œå¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œæ‹·è´å’Œè½¬ç§»</p>
<p>å†æ¥çœ‹çœ‹çœŸæ­£æ‰§è¡Œæ¬è¿å·¥ä½œçš„<code>growWork()</code>å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// make sure we evacuate the oldbucket corresponding
</span><span class="c1"></span>  <span class="c1">// to the bucket we&#39;re about to use
</span><span class="c1"></span>  <span class="c1">// ç¡®è®¤æ¬è¿è€çš„ bucket å¯¹åº”æ­£åœ¨ä½¿ç”¨çš„ bucket
</span><span class="c1"></span>	<span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nf">oldbucketmask</span><span class="p">())</span>

  <span class="c1">// evacuate one more oldbucket to make progress on growing
</span><span class="c1"></span>  <span class="c1">// å†æ¬è¿ä¸€ä¸ª bucketï¼Œä»¥åŠ å¿«æ¬è¿è¿›ç¨‹
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é›†ä¸­æ‰€æœ‰çš„ç²¾åŠ›åœ¨æ¬è¿çš„å…³é”®å‡½æ•° evacuate</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">oldbucket</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// å®šä½è€çš„ bucket åœ°å€
</span><span class="c1"></span>  <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
  <span class="c1">// ç»“æœæ˜¯ 2^Bï¼Œå¦‚ B = 5ï¼Œç»“æœä¸º32
</span><span class="c1"></span>  <span class="nx">newbit</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">noldbuckets</span><span class="p">()</span>
  <span class="c1">// å¦‚æœ b æ²¡æœ‰è¢«æ¬è¿è¿‡
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO: reuse overflow buckets instead of using new ones, if there
</span><span class="c1"></span>    <span class="c1">// is no iterator using the old buckets.  (If !oldIterator.)
</span><span class="c1"></span>
    <span class="c1">// xy contains the x and y (low and high) evacuation destinations.
</span><span class="c1"></span>    <span class="c1">// xy åŒ…å«çš„æ˜¯ç§»åŠ¨çš„ç›®æ ‡
</span><span class="c1"></span>    <span class="c1">// x è¡¨ç¤ºæ–° bucket æ•°ç»„çš„å‰(low)åŠéƒ¨åˆ†
</span><span class="c1"></span>    <span class="c1">// y è¡¨ç¤ºæ–° bucket æ•°ç»„çš„å(high)åŠéƒ¨åˆ†
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">xy</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">evacDst</span>
    <span class="nx">x</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>

    <span class="c1">// å¦‚æœä¸æ˜¯ç­‰ size æ‰©å®¹ï¼Œå‰å bucket åºå·æœ‰å˜
</span><span class="c1"></span>    <span class="c1">// ä½¿ç”¨ y æ¥è¿›è¡Œæ¬è¿
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Only calculate y pointers if we&#39;re growing bigger.
</span><span class="c1"></span>      <span class="c1">// Otherwise GC can see bad pointers.
</span><span class="c1"></span>      <span class="c1">// å¦‚æœ map å¤§å°(hmap.B)å¢å¤§äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè®¡ç®— y
</span><span class="c1"></span>      <span class="c1">// å¦åˆ™ GC å¯èƒ½ä¼šçœ‹åˆ°æŸåçš„æŒ‡é’ˆ
</span><span class="c1"></span>      <span class="nx">y</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">oldbucket</span><span class="o">+</span><span class="nx">newbit</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// éå†æ‰€æœ‰çš„ bucketï¼ŒåŒ…æ‹¬ overflow buckets
</span><span class="c1"></span>    <span class="c1">// b æ˜¯è€çš„ bucket åœ°å€
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
      <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
      <span class="c1">// éå† bucket ä¸­çš„æ‰€æœ‰ cell
</span><span class="c1"></span>      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nf">add</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)),</span> <span class="nf">add</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// å½“å‰ cell çš„ top hash å€¼
</span><span class="c1"></span>        <span class="nx">top</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="c1">// å¦‚æœ cell ä¸ºç©ºï¼Œå³æ²¡æœ‰ key
</span><span class="c1"></span>        <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">top</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// é‚£å°±æ ‡å¿—å®ƒè¢«&#34;æ¬è¿&#34;è¿‡
</span><span class="c1"></span>          <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">evacuatedEmpty</span>
          <span class="k">continue</span>
        <span class="p">}</span>
        <span class="c1">// æ­£å¸¸ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µ
</span><span class="c1"></span>        <span class="c1">// æœªè¢«æ¬è¿çš„ cell åªå¯èƒ½æ˜¯ empty æˆ–æ˜¯
</span><span class="c1"></span>        <span class="c1">// æ­£å¸¸çš„ top hashï¼ˆå¤§äº minTopHashï¼‰
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">top</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span> <span class="p">{</span>
          <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad map state&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">k2</span> <span class="o">:=</span> <span class="nx">k</span>
        <span class="c1">// å¦‚æœ key æ˜¯æŒ‡é’ˆï¼Œåˆ™è§£å¼•ç”¨
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">k2</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k2</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">useY</span> <span class="kt">uint8</span>
        <span class="c1">// å¦‚æœä¸æ˜¯ç­‰é‡æ‰©å®¹
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// Compute hash to make our evacuation decision (whether we need
</span><span class="c1"></span>          <span class="c1">// to send this key/elem to bucket x or bucket y).
</span><span class="c1"></span>          <span class="c1">// è®¡ç®—å“ˆå¸Œï¼Œä»¥åˆ¤æ–­æˆ‘ä»¬çš„æ•°æ®è¦è½¬ç§»åˆ°å“ªä¸€éƒ¨åˆ†çš„ bucket
</span><span class="c1"></span>          <span class="c1">// å¯èƒ½æ˜¯ x éƒ¨åˆ†ï¼Œä¹Ÿå¯èƒ½æ˜¯ y éƒ¨åˆ†
</span><span class="c1"></span>          <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">k2</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
          <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">iterator</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k2</span><span class="p">,</span> <span class="nx">k2</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If key != key (NaNs), then the hash could be (and probably
</span><span class="c1"></span>            <span class="c1">// will be) entirely different from the old hash. Moreover,
</span><span class="c1"></span>            <span class="c1">// it isn&#39;t reproducible. Reproducibility is required in the
</span><span class="c1"></span>            <span class="c1">// presence of iterators, as our evacuation decision must
</span><span class="c1"></span>            <span class="c1">// match whatever decision the iterator made.
</span><span class="c1"></span>            <span class="c1">// Fortunately, we have the freedom to send these keys either
</span><span class="c1"></span>            <span class="c1">// way. Also, tophash is meaningless for these kinds of keys.
</span><span class="c1"></span>            <span class="c1">// We let the low bit of tophash drive the evacuation decision.
</span><span class="c1"></span>            <span class="c1">// We recompute a new random tophash for the next level so
</span><span class="c1"></span>            <span class="c1">// these keys will get evenly distributed across all buckets
</span><span class="c1"></span>            <span class="c1">// after multiple grows.
</span><span class="c1"></span>            <span class="c1">// ä¸ºä»€ä¹ˆè¦åŠ  reflexivekey çš„åˆ¤æ–­ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ:
</span><span class="c1"></span>            <span class="c1">// https://go-review.googlesource.com/c/go/+/1480
</span><span class="c1"></span>            <span class="c1">// key != keyï¼Œåªæœ‰åœ¨ float æ•°çš„ NaN æ—¶ä¼šå‡ºç°
</span><span class="c1"></span>            <span class="c1">// æ¯”å¦‚:
</span><span class="c1"></span>            <span class="c1">// n1 := math.NaN()
</span><span class="c1"></span>            <span class="c1">// n2 := math.NaN()
</span><span class="c1"></span>            <span class="c1">// fmt.Println(n1, n2)
</span><span class="c1"></span>            <span class="c1">// fmt.Println(n1 == n2)
</span><span class="c1"></span>            <span class="c1">// è¿™ç§æƒ…å†µä¸‹ n1 å’Œ n2 çš„å“ˆå¸Œå€¼ä¹Ÿå®Œå…¨ä¸ä¸€æ ·
</span><span class="c1"></span>            <span class="c1">// è¿™é‡Œå®˜æ–¹è¡¨ç¤ºè¿™ç§æƒ…å†µæ˜¯ä¸å¯å¤ç°çš„
</span><span class="c1"></span>            <span class="c1">// éœ€è¦åœ¨ iterators å‚ä¸çš„æƒ…å†µä¸‹æ‰èƒ½å¤ç°
</span><span class="c1"></span>            <span class="c1">// ä½†æ˜¯å¯¹äºè¿™ç§ key æˆ‘ä»¬ä¹Ÿå¯ä»¥éšæ„å¯¹å…¶ç›®æ ‡è¿›è¡Œå‘é…
</span><span class="c1"></span>            <span class="c1">// åŒæ—¶ tophash å¯¹äº NaN ä¹Ÿæ²¡å•¥æ„ä¹‰
</span><span class="c1"></span>            <span class="c1">// è¿˜æ˜¯æŒ‰æ­£å¸¸çš„æƒ…å†µä¸‹ç®—ä¸€ä¸ªéšæœºçš„ tophash
</span><span class="c1"></span>            <span class="c1">// ç„¶åå…¬å¹³åœ°æŠŠè¿™äº› key å¹³å‡åˆ†å¸ƒåˆ°å„ bucket å°±å¥½
</span><span class="c1"></span>            <span class="nx">useY</span> <span class="p">=</span> <span class="nx">top</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="c1">// è®©è¿™ä¸ª key 50% æ¦‚ç‡å» Y åŠåŒº
</span><span class="c1"></span>            <span class="nx">top</span> <span class="p">=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// è¿™é‡Œå†™çš„æ¯”è¾ƒ trick
</span><span class="c1"></span>            <span class="c1">// æ¯”å¦‚å½“å‰æœ‰ 8 ä¸ªæ¡¶
</span><span class="c1"></span>            <span class="c1">// é‚£ä¹ˆå¦‚æœ hash &amp; 8 != 0
</span><span class="c1"></span>            <span class="c1">// é‚£ä¹ˆè¯´æ˜è¿™ä¸ªå…ƒç´ çš„ hash è¿™ç§å½¢å¼
</span><span class="c1"></span>            <span class="c1">// xxx1xxx
</span><span class="c1"></span>            <span class="c1">// è€Œæ‰©å®¹åçš„ bucketMask æ˜¯
</span><span class="c1"></span>            <span class="c1">//    1111
</span><span class="c1"></span>            <span class="c1">// æ‰€ä»¥å®é™…ä¸Šè¿™ä¸ªå°±æ˜¯
</span><span class="c1"></span>            <span class="c1">// xxx1xxx &amp; 1000 &gt; 0
</span><span class="c1"></span>            <span class="c1">// è¯´æ˜è¿™ä¸ªå…ƒç´ åœ¨æ‰©å®¹åä¸€å®šä¼šå»ä¸‹åŠåŒºï¼Œå³Yéƒ¨åˆ†
</span><span class="c1"></span>            <span class="c1">// æ‰€ä»¥å°±æ˜¯ useY äº†
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">hash</span><span class="o">&amp;</span><span class="nx">newbit</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
              <span class="nx">useY</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">evacuatedX</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">evacuatedY</span> <span class="o">||</span> <span class="nx">evacuatedX</span><span class="p">^</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">evacuatedY</span> <span class="p">{</span>
          <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad evacuatedN&#34;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">evacuatedX</span> <span class="o">+</span> <span class="nx">useY</span> <span class="c1">// evacuatedX + 1 == evacuatedY
</span><span class="c1"></span>        <span class="nx">dst</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="nx">useY</span><span class="p">]</span>                 <span class="c1">// evacuation destination ç§»åŠ¨ç›®æ ‡
</span><span class="c1"></span>
        <span class="k">if</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">bucketCnt</span> <span class="p">{</span>
          <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>
          <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
          <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
          <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">dst</span><span class="p">.</span><span class="nx">i</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">bucketCnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">=</span> <span class="nx">top</span> <span class="c1">// mask dst.i as an optimization, to avoid a bounds check
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
          <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">)</span> <span class="p">=</span> <span class="nx">k2</span> <span class="c1">// æ‹·è´æŒ‡é’ˆ
</span><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="c1">// æ‹·è´å€¼
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
          <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">)</span> <span class="p">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span><span class="o">++</span>
        <span class="c1">// These updates might push these pointers past the end of the
</span><span class="c1"></span>        <span class="c1">// key or elem arrays.  That&#39;s ok, as we have the overflow pointer
</span><span class="c1"></span>        <span class="c1">// at the end of the bucket to protect against pointing past the
</span><span class="c1"></span>        <span class="c1">// end of the bucket.
</span><span class="c1"></span>        <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
        <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Unlink the overflow buckets &amp; clear key/elem to help GC.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">oldIterator</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">b</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">))</span>
      <span class="c1">// Preserve b.tophash because the evacuation
</span><span class="c1"></span>      <span class="c1">// state is maintained there.
</span><span class="c1"></span>      <span class="nx">ptr</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">dataOffset</span><span class="p">)</span>
      <span class="nx">n</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)</span> <span class="o">-</span> <span class="nx">dataOffset</span>
      <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">oldbucket</span> <span class="o">==</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="p">{</span>
    <span class="nf">advanceEvacuationMark</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">newbit</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p><code>runtime.evacuate</code> æœ€åä¼šè°ƒç”¨<code>runtime.advanceEvacuationMark</code> å¢åŠ å“ˆå¸Œçš„<code>nevacuate</code>è®¡æ•°å™¨å¹¶åœ¨æ‰€æœ‰çš„æ—§æ¡¶éƒ½è¢«åˆ†æµåæ¸…ç©ºå“ˆå¸Œçš„ oldbuckets å’Œ oldoverflowï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">advanceEvacuationMark</span><span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">newbit</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="o">++</span>
  <span class="c1">// Experiments suggest that 1024 is overkill by at least an order of magnitude.
</span><span class="c1"></span>  <span class="c1">// Put it in there as a safeguard anyway, to ensure O(1) behavior.
</span><span class="c1"></span>  <span class="nx">stop</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">+</span> <span class="mi">1024</span>
  <span class="k">if</span> <span class="nx">stop</span> <span class="p">&gt;</span> <span class="nx">newbit</span> <span class="p">{</span>
    <span class="nx">stop</span> <span class="p">=</span> <span class="nx">newbit</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">!=</span> <span class="nx">stop</span> <span class="o">&amp;&amp;</span> <span class="nf">bucketEvacuated</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">==</span> <span class="nx">newbit</span> <span class="p">{</span> <span class="c1">// newbit == # of oldbuckets
</span><span class="c1"></span>    <span class="c1">// Growing is all done. Free old main bucket array.
</span><span class="c1"></span>    <span class="c1">// å¤§å°å¢é•¿å…¨éƒ¨ç»“æŸã€‚é‡Šæ”¾è€çš„ bucket array
</span><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="c1">// Can discard old overflow buckets as well.
</span><span class="c1"></span>    <span class="c1">// If they are still referenced by an iterator,
</span><span class="c1"></span>    <span class="c1">// then the iterator holds a pointers to the slice.
</span><span class="c1"></span>    <span class="c1">// åŒæ ·å¯ä»¥ä¸¢å¼ƒè€çš„ overflow buckets
</span><span class="c1"></span>    <span class="c1">// å¦‚æœå®ƒä»¬è¿˜è¢«è¿­ä»£å™¨æ‰€å¼•ç”¨çš„è¯
</span><span class="c1"></span>    <span class="c1">// è¿­ä»£å™¨ä¼šæŒæœ‰ä¸€ä»½æŒ‡å‘ slice çš„æŒ‡é’ˆ
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^=</span> <span class="nx">sameSizeGrow</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>æ‰©å®¹å¹¶ä¸æ˜¯ä¸€æ¬¡å°±å®Œæˆçš„ï¼Œè€Œæ˜¯æ¸è¿›çš„</p>
<p>åœ¨<code>runtime.mapassign</code>å‡½æ•°ä¸­ä¹Ÿçœç•¥äº†ä¸€æ®µé€»è¾‘ï¼Œå½“å“ˆå¸Œè¡¨æ­£åœ¨å¤„äºæ‰©å®¹çŠ¶æ€æ—¶ï¼Œæ¯æ¬¡å‘å“ˆå¸Œè¡¨å†™å…¥å€¼æ—¶éƒ½ä¼šè§¦å‘<code>runtime.growWork</code>å¢é‡æ‹·è´å“ˆå¸Œè¡¨ä¸­çš„å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapassign</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
<span class="o">...</span>
<span class="nx">again</span><span class="p">:</span>
	<span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">)</span>
	<span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å½“ç„¶åœ¨<code>runtime.mapdelete</code>å‡½æ•°ä¸­ä¹Ÿä¼šè§¦å‘<code>runtime.growWork</code>å¢é‡æ‹·è´å“ˆå¸Œè¡¨ä¸­çš„å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapdelete</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
<span class="o">...</span>
	<span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">)</span>
	<span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>ä¹‹å‰åœ¨åˆ†æå“ˆå¸Œè¡¨è®¿é—®å‡½æ•°<code>runtime.mapaccess1</code>æ—¶å…¶å®çœç•¥äº†æ‰©å®¹æœŸé—´è·å–é”®å€¼å¯¹çš„é€»è¾‘ï¼Œå½“å“ˆå¸Œè¡¨çš„ oldbuckets å­˜åœ¨æ—¶ï¼Œä¼šå…ˆå®šä½åˆ°æ—§æ¡¶å¹¶åœ¨è¯¥æ¡¶æ²¡æœ‰è¢«åˆ†æµæ—¶ä»ä¸­è·å–é”®å€¼å¯¹ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapaccess1</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="nx">alg</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">alg</span>
  <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">alg</span><span class="p">.</span><span class="nf">hash</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
  <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
    <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">bucketloop</span><span class="p">:</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å› ä¸ºæ—§æ¡¶ä¸­çš„å…ƒç´ è¿˜æ²¡æœ‰è¢« runtime.evacuate å‡½æ•°åˆ†æµï¼Œå…¶ä¸­è¿˜ä¿å­˜ç€æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ•°æ®ï¼Œæ‰€ä»¥æ—§æ¡¶ä¼šæ›¿ä»£æ–°åˆ›å»ºçš„ç©ºæ¡¶æä¾›æ•°æ®ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹å“ˆå¸Œè¡¨æ‰©å®¹çš„è®¾è®¡å’ŒåŸç†ï¼Œå“ˆå¸Œåœ¨å­˜å‚¨å…ƒç´ è¿‡å¤šæ—¶ä¼šè§¦å‘æ‰©å®¹æ“ä½œï¼Œæ¯æ¬¡éƒ½ä¼šå°†æ¡¶çš„æ•°é‡ç¿»å€ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸æ˜¯åŸå­çš„ï¼Œè€Œæ˜¯é€šè¿‡ runtime.growWork å¢é‡è§¦å‘çš„ï¼Œåœ¨æ‰©å®¹æœŸé—´è®¿é—®å“ˆå¸Œè¡¨æ—¶ä¼šä½¿ç”¨æ—§æ¡¶ï¼Œå‘å“ˆå¸Œè¡¨å†™å…¥æ•°æ®æ—¶ä¼šè§¦å‘æ—§æ¡¶å…ƒç´ çš„åˆ†æµã€‚é™¤äº†è¿™ç§æ­£å¸¸çš„æ‰©å®¹ä¹‹å¤–ï¼Œä¸ºäº†è§£å†³å¤§é‡å†™å…¥ã€åˆ é™¤é€ æˆçš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå“ˆå¸Œå¼•å…¥äº† sameSizeGrow è¿™ä¸€æœºåˆ¶ï¼Œåœ¨å‡ºç°è¾ƒå¤šæº¢å‡ºæ¡¶æ—¶ä¼šæ•´ç†å“ˆå¸Œçš„å†…å­˜å‡å°‘ç©ºé—´çš„å ç”¨ã€‚</p>
<p>sameSizeGrowçš„å›¾ç¤º</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/SameSizeGrow.png" alt="mapéå†"></p>
<p>biggerSizeGrowçš„å›¾ç¤º</p>
<p><img src="/Golang-map%E6%8E%A2%E9%99%A9/BiggerSizeGrow.png" alt="mapéå†"></p>
<h3 id="mapåˆ é™¤"><a href="#mapåˆ é™¤" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:mapåˆ é™¤" class="headings">mapåˆ é™¤</a></h3>
<p>å¦‚æœæƒ³è¦åˆ é™¤å“ˆå¸Œä¸­çš„å…ƒç´ ï¼Œå°±éœ€è¦ä½¿ç”¨ Go è¯­è¨€ä¸­çš„ delete å…³é”®å­—ï¼Œè¿™ä¸ªå…³é”®å­—çš„å”¯ä¸€ä½œç”¨å°±æ˜¯å°†æŸä¸€ä¸ªé”®å¯¹åº”çš„å…ƒç´ ä»å“ˆå¸Œè¡¨ä¸­åˆ é™¤ï¼Œæ— è®ºæ˜¯è¯¥é”®å¯¹åº”çš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œè¿™ä¸ªå†…å»ºçš„å‡½æ•°éƒ½ä¸ä¼šè¿”å›ä»»ä½•çš„ç»“æœã€‚</p>
<p>åœ¨ç¼–è¯‘æœŸé—´ï¼Œ<code>delete</code>å…³é”®å­—ä¼šè¢«è½¬æ¢æˆæ“ä½œä¸º<code>ODELETE</code>çš„èŠ‚ç‚¹ï¼Œè€Œ<code>cmd/compile/internal/gc.walkexpr</code>ä¼šå°†<code>ODELETE</code>èŠ‚ç‚¹è½¬æ¢æˆ<code>runtime.mapdelete</code>å‡½æ•°ç°‡ä¸­çš„ä¸€ä¸ªï¼ŒåŒ…æ‹¬ <code>runtime.mapdelete</code>ã€<code>mapdelete_faststr</code>ã€<code>mapdelete_fast32</code> å’Œ <code>mapdelete_fast64</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">walkexpr</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">init</span> <span class="o">*</span><span class="nx">Nodes</span><span class="p">)</span> <span class="o">*</span><span class="nx">Node</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">ODELETE</span><span class="p">:</span>
		<span class="nx">init</span><span class="p">.</span><span class="nf">AppendNodes</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">Ninit</span><span class="p">)</span>
		<span class="nx">map_</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">First</span><span class="p">()</span>
		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Second</span><span class="p">()</span>
		<span class="nx">map_</span> <span class="p">=</span> <span class="nf">walkexpr</span><span class="p">(</span><span class="nx">map_</span><span class="p">,</span> <span class="nx">init</span><span class="p">)</span>
		<span class="nx">key</span> <span class="p">=</span> <span class="nf">walkexpr</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">init</span><span class="p">)</span>

		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">map_</span><span class="p">.</span><span class="nx">Type</span>
		<span class="nx">fast</span> <span class="o">:=</span> <span class="nf">mapfast</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">fast</span> <span class="o">==</span> <span class="nx">mapslow</span> <span class="p">{</span>
			<span class="nx">key</span> <span class="p">=</span> <span class="nf">nod</span><span class="p">(</span><span class="nx">OADDR</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">n</span> <span class="p">=</span> <span class="nf">mkcall1</span><span class="p">(</span><span class="nf">mapfndel</span><span class="p">(</span><span class="nx">mapdelete</span><span class="p">[</span><span class="nx">fast</span><span class="p">],</span> <span class="nx">t</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="nf">typename</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">map_</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>è¿™äº›å‡½æ•°çš„å®ç°å…¶å®å·®ä¸å¤šï¼Œæˆ‘ä»¬æŒ‘é€‰å…¶ä¸­çš„<code>runtime.mapdelete</code>åˆ†æä¸€ä¸‹ã€‚å“ˆå¸Œè¡¨çš„åˆ é™¤é€»è¾‘ä¸å†™å…¥é€»è¾‘å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯è§¦å‘å“ˆå¸Œçš„åˆ é™¤éœ€è¦ä½¿ç”¨å…³é”®å­—ï¼Œå¦‚æœåœ¨åˆ é™¤æœŸé—´é‡åˆ°äº†å“ˆå¸Œè¡¨çš„æ‰©å®¹ï¼Œå°±ä¼šåˆ†æµæ¡¶ä¸­çš„å…ƒç´ ï¼Œåˆ†æµç»“æŸä¹‹åä¼šæ‰¾åˆ°æ¡¶ä¸­çš„ç›®æ ‡å…ƒç´ å®Œæˆé”®å€¼å¯¹çš„åˆ é™¤å·¥ä½œã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">mapdelete</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hashMightPanic</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// see issue 23734
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>

  <span class="c1">// Set hashWriting after calling t.hasher, since t.hasher may panic,
</span><span class="c1"></span>  <span class="c1">// in which case we have not actually done a write (delete).
</span><span class="c1"></span>  <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">^=</span> <span class="nx">hashWriting</span>

  <span class="c1">// æŒ‰ä½ 8 ä½ hash å€¼é€‰æ‹© bucket
</span><span class="c1"></span>  <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// æŒ‰ä¸Šé¢ç®—å‡ºçš„æ¡¶çš„ç´¢å¼•ï¼Œæ‰¾åˆ° bucket çš„å†…å­˜åœ°å€
</span><span class="c1"></span>  <span class="c1">// å¹¶å¼ºåˆ¶è½¬æ¢ä¸ºéœ€è¦çš„ bmap ç»“æ„
</span><span class="c1"></span>  <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
  <span class="nx">bOrig</span> <span class="o">:=</span> <span class="nx">b</span>
  <span class="c1">// é«˜ 8 ä½ hash å€¼
</span><span class="c1"></span>  <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
  <span class="nx">search</span><span class="p">:</span>
  <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="c1">// 8 ä¸ªæ§½ä½ï¼Œåˆ†åˆ«å¯¹æ¯” tophash
</span><span class="c1"></span>      <span class="c1">// æ²¡æ‰¾åˆ°çš„è¯å°±å»å¤–å›´ for å¾ªç¯çš„ overflow é“¾è¡¨ä¸­ç»§ç»­æŸ¥æ‰¾
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
          <span class="k">break</span> <span class="nx">search</span>
        <span class="p">}</span>
        <span class="k">continue</span>
      <span class="p">}</span>
        <span class="c1">// è®¡ç®— k æ‰€åœ¨çš„æ§½ä½çš„å†…å­˜åœ°å€
</span><span class="c1"></span>      <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
      <span class="nx">k2</span> <span class="o">:=</span> <span class="nx">k</span>
      <span class="c1">// å¦‚æœ key &gt; 128 å­—èŠ‚
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">k2</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k2</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span>
      <span class="p">}</span>
      <span class="c1">// Only clear key if there are pointers in it.
</span><span class="c1"></span>      <span class="c1">// å¦‚æœ key ä¸­æ˜¯æŒ‡é’ˆï¼Œé‚£ä¹ˆæ¸…ç©º key çš„å†…å®¹
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">)</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// è®¡ç®— value æ‰€åœ¨çš„å†…å­˜åœ°å€
</span><span class="c1"></span>      <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// è®¾ç½® tophash[i] = 0
</span><span class="c1"></span>      <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">emptyOne</span>
      <span class="c1">// If the bucket now ends in a bunch of emptyOne states,
</span><span class="c1"></span>      <span class="c1">// change those to emptyRest states.
</span><span class="c1"></span>      <span class="c1">// It would be nice to make this a separate function, but
</span><span class="c1"></span>      <span class="c1">// for loops are not currently inlineable.
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">bucketCnt</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyRest</span> <span class="p">{</span>
          <span class="k">goto</span> <span class="nx">notLast</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyRest</span> <span class="p">{</span>
          <span class="k">goto</span> <span class="nx">notLast</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">{</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">emptyRest</span>
        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
          <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="nx">bOrig</span> <span class="p">{</span>
            <span class="k">break</span> <span class="c1">// beginning of initial bucket, we&#39;re done.
</span><span class="c1"></span>          <span class="p">}</span>
          <span class="c1">// Find previous bucket, continue at its last entry.
</span><span class="c1"></span>          <span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span>
          <span class="k">for</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">bOrig</span><span class="p">;</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
          <span class="p">}</span>
          <span class="nx">i</span> <span class="p">=</span> <span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">i</span><span class="o">--</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyOne</span> <span class="p">{</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="nx">notLast</span><span class="p">:</span>
      <span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>
      <span class="c1">// Reset the hash seed to make it more difficult for attackers to
</span><span class="c1"></span>      <span class="c1">// repeatedly trigger hash collisions. See issue 25237.
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span> <span class="p">=</span> <span class="nf">fastrand</span><span class="p">()</span>
      <span class="p">}</span>
      <span class="k">break</span> <span class="nx">search</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^=</span> <span class="nx">hashWriting</span>
  <span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>æˆ‘ä»¬å…¶å®åªéœ€è¦çŸ¥é“<code>delete</code>å…³é”®å­—åœ¨ç¼–è¯‘æœŸé—´ç»è¿‡ç±»å‹æ£€æŸ¥å’Œä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µè¢«è½¬æ¢æˆ<code>runtime.mapdelete</code>å‡½æ•°ç°‡ä¸­çš„ä¸€å‘˜ï¼Œç”¨äºå¤„ç†åˆ é™¤é€»è¾‘çš„å‡½æ•°ä¸å“ˆå¸Œè¡¨çš„<code>runtime.mapassign</code>å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä¸å¤ªéœ€è¦åˆ»æ„å…³æ³¨ã€‚</p>
<h3 id="indirectkey-å’Œ-indirectvalue"><a href="#indirectkey-å’Œ-indirectvalue" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:indirectkey-å’Œ-indirectvalue" class="headings">indirectkey å’Œ indirectvalue</a></h3>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬è§è¿‡æ— æ•°æ¬¡çš„ indirectkey å’Œ indirectvalueã€‚indirectkey å’Œ indirectvalue åœ¨ map é‡Œå®é™…å­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼Œä¼šé€ æˆ GC æ‰«ææ—¶ï¼Œæ‰«ææ›´å¤šçš„å¯¹è±¡ã€‚è‡³äºæ˜¯å¦æ˜¯ indirectï¼Œä¾ç„¶æ˜¯ç”±ç¼–è¯‘å™¨æ¥å†³å®šçš„ï¼Œä¾æ®æ˜¯:</p>
<ul>
<li>key &gt; 128 å­—èŠ‚æ—¶ï¼Œindirectkey = true</li>
<li>value &gt; 128 å­—èŠ‚æ—¶ï¼Œindirectvalue = true</li>
</ul>
<h3 id="overflow-å¤„ç†"><a href="#overflow-å¤„ç†" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:overflow-å¤„ç†" class="headings">overflow å¤„ç†</a></h3>
<p>æ€è·¯: ä» nextOverflow ä¸­æ‹¿ overflow bucketï¼Œå¦‚æœæ‹¿åˆ°ï¼Œå°±æ”¾è¿› hmap.extra.overflow æ•°ç»„ï¼Œå¹¶è®© bmap çš„ overflow pointer æŒ‡å‘è¿™ä¸ª bucketã€‚</p>
<p>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œé‚£å°± new ä¸€ä¸ªã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="o">*</span><span class="nx">bmap</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">ovf</span> <span class="o">*</span><span class="nx">bmap</span>
	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// We have preallocated overflow buckets available.
</span><span class="c1"></span>		<span class="c1">// See makeBucketArray for more details.
</span><span class="c1"></span>		<span class="nx">ovf</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span>
		<span class="k">if</span> <span class="nx">ovf</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// We&#39;re not at the end of the preallocated overflow buckets. Bump the pointer.
</span><span class="c1"></span>			<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ovf</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// This is the last preallocated overflow bucket.
</span><span class="c1"></span>			<span class="c1">// Reset the overflow pointer on this bucket,
</span><span class="c1"></span>			<span class="c1">// which was set to a non-nil sentinel value.
</span><span class="c1"></span>			<span class="nx">ovf</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
			<span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">ovf</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="nx">h</span><span class="p">.</span><span class="nf">incrnoverflow</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">h</span><span class="p">.</span><span class="nf">createOverflow</span><span class="p">()</span>
		<span class="o">*</span><span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="o">*</span><span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span><span class="p">,</span> <span class="nx">ovf</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">b</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">ovf</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ovf</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">createOverflow</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mapextra</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nb">new</span><span class="p">([]</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// incrnoverflow increments h.noverflow.
</span><span class="c1">// noverflow counts the number of overflow buckets.
</span><span class="c1">// This is used to trigger same-size map growth.
</span><span class="c1">// See also tooManyOverflowBuckets.
</span><span class="c1">// To keep hmap small, noverflow is a uint16.
</span><span class="c1">// When there are few buckets, noverflow is an exact count.
</span><span class="c1">// When there are many buckets, noverflow is an approximate count.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">incrnoverflow</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// We trigger same-size map growth if there are
</span><span class="c1"></span>	<span class="c1">// as many overflow buckets as buckets.
</span><span class="c1"></span>	<span class="c1">// We need to be able to count to 1&lt;&lt;h.B.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">&lt;</span> <span class="mi">16</span> <span class="p">{</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="o">++</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">// Increment with probability 1/(1&lt;&lt;(h.B-15)).
</span><span class="c1"></span>	<span class="c1">// When we reach 1&lt;&lt;15 - 1, we will have approximately
</span><span class="c1"></span>	<span class="c1">// as many overflow buckets as buckets.
</span><span class="c1"></span>	<span class="nx">mask</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="c1">// Example: if h.B == 18, then mask == 7,
</span><span class="c1"></span>	<span class="c1">// and fastrand &amp; 7 == 0 with probability 1/8.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nf">fastrand</span><span class="p">()</span><span class="o">&amp;</span><span class="nx">mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="o">++</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table></div>
</div>
</div><p>å°ç»“</p>
<p>Go è¯­è¨€ä½¿ç”¨æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œç¢°æ’çš„é—®é¢˜å®ç°äº†å“ˆå¸Œè¡¨ï¼Œå®ƒçš„è®¿é—®ã€å†™å…¥å’Œåˆ é™¤ç­‰æ“ä½œéƒ½åœ¨ç¼–è¯‘æœŸé—´è½¬æ¢æˆäº†è¿è¡Œæ—¶çš„å‡½æ•°æˆ–è€…æ–¹æ³•ã€‚å“ˆå¸Œåœ¨æ¯ä¸€ä¸ªæ¡¶ä¸­å­˜å‚¨é”®å¯¹åº”å“ˆå¸Œçš„å‰ 8 ä½ï¼Œå½“å¯¹å“ˆå¸Œè¿›è¡Œæ“ä½œæ—¶ï¼Œè¿™äº› tophash å°±æˆä¸ºå¯ä»¥å¸®åŠ©å“ˆå¸Œå¿«é€Ÿéå†æ¡¶ä¸­å…ƒç´ çš„ç¼“å­˜ã€‚</p>
<p>å“ˆå¸Œè¡¨çš„æ¯ä¸ªæ¡¶éƒ½åªèƒ½å­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹ï¼Œä¸€æ—¦å½“å‰å“ˆå¸Œçš„æŸä¸ªæ¡¶è¶…å‡º 8 ä¸ªï¼Œæ–°çš„é”®å€¼å¯¹å°±ä¼šå­˜å‚¨åˆ°å“ˆå¸Œçš„æº¢å‡ºæ¡¶ä¸­ã€‚éšç€é”®å€¼å¯¹æ•°é‡çš„å¢åŠ ï¼Œæº¢å‡ºæ¡¶çš„æ•°é‡å’Œå“ˆå¸Œçš„è£…è½½å› å­ä¹Ÿä¼šé€æ¸å‡é«˜ï¼Œè¶…è¿‡ä¸€å®šèŒƒå›´å°±ä¼šè§¦å‘æ‰©å®¹ï¼Œæ‰©å®¹ä¼šå°†æ¡¶çš„æ•°é‡ç¿»å€ï¼Œå…ƒç´ å†åˆ†é…çš„è¿‡ç¨‹ä¹Ÿæ˜¯åœ¨è°ƒç”¨å†™æ“ä½œæ—¶å¢é‡è¿›è¡Œçš„ï¼Œä¸ä¼šé€ æˆæ€§èƒ½çš„ç¬æ—¶å·¨å¤§æŠ–åŠ¨ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:å‚è€ƒèµ„æ–™" class="headings">å‚è€ƒèµ„æ–™</a></h3>
<ul>
<li><a href="https://www.cnblogs.com/qcrao-2018/p/10903807.html" target="_blank" rel="noopener">æ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹map</a></li>
<li><a href="https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-hashmap/" target="_blank" rel="noopener">å“ˆå¸Œè¡¨</a></li>
<li><a href="https://github.com/cch123/golang-notes/blob/master/map.md" target="_blank" rel="noopener">map.md</a></li>
</ul>
            </div>

            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">ä½œè€…</span>ï¼š<a href="https://www.wemeng.top/" class="p-author h-card" target="_blank" rel="noopener">æ‡’ç™Œæ­£æ‚£è€…</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">é“¾æ¥</span>ï¼š<a href="/posts/golang-map%E6%8E%A2%E9%99%A9/" target="_blank" rel="noopener">http://www.wemeng.top/posts/golang-mapæ¢é™©/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">è®¸å¯</span>ï¼š<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></li>
            
        </ul>
    



        </article>

        

        
    <div class="updated-badge-container">
        <span title="Updated @ 2020-12-18 20:31:14 CST" style="cursor:help">

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2020-12-18</text><text x="915" y="140" textLength="650" transform="scale(.1)">2020-12-18</text></g></svg>
        </span></div>



        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;text=Golang%20map%e6%8e%a2%e9%99%a9&amp;hashtags=Golang%e5%9f%ba%e7%a1%80,&amp;via=%e6%87%92%e7%99%8c%e6%ad%a3%e6%82%a3%e8%80%85" title="åˆ†äº«åˆ°ã€ŒTwitterã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            
                <div class="share-item facebook">
                    
                    <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;hashtag=%23Golang%e5%9f%ba%e7%a1%80" title="åˆ†äº«åˆ°ã€ŒFacebookã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a>
                </div>
            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;title=Golang%20map%e6%8e%a2%e9%99%a9&amp;summary=%e5%89%8d%e8%a8%80%20map%e6%98%af%e4%b8%80%e7%a7%8d%e5%be%88%e5%9f%ba%e7%a1%80%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%8cJava%e4%b8%ad%e7%9a%84HashMap%e4%bd%bf%e7%94%a8%e6%95%b0%e7%bb%84&#43;%e9%93%be%e8%a1%a8%e7%9a%84%e6%96%b9%e5%bc%8f%e6%9d%a5%e5%ae%9e%e7%8e%b0%ef%bc%8cGolang%e5%86%85%e7%bd%aemap%e5%ba%95%e5%b1%82%e6%98%af%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e7%bb%93%e6%9e%84%e5%91%a2%ef%bc%9f%0a%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84%20%e5%9c%a8go%e4%b8%admap%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhmap%e8%bf%99%e4%b8%aa%e7%bb%93%e6%9e%84%e6%9d%a5%e8%a1%a8%e7%a4%ba%0a1%202%203%204%205%206%207%208%209%2010%2011%2012%2013%2014%2015%2016%20%20//%20A%20header%20for%20a%20Go%20map.%20type%20hmap%20struct%20%7b%20//%20Note:%20the%20format%20of%20the%20hmap%20is%20also%20encoded%20in%20cmd/compile/internal/gc/reflect.go.%20%09//%20Make%20sure%20this%20stays%20in%20sync%20with%20the%20compiler%27s%20definition.%20%09count%20int%20//%20map%20%e4%b8%ad%e7%9a%84%e5%85%83%e7%b4%a0%e4%b8%aa%e6%95%b0%ef%bc%8c%e5%bf%85%e9%a1%bb%e6%94%be%e5%9c%a8%20struct%20%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%bd%8d%e7%bd%ae%ef%bc%8c%e5%9b%a0%e4%b8%ba%20%e5%86%85%e7%bd%ae%e7%9a%84%20len%20%e5%87%bd%e6%95%b0%e4%bc%9a%e4%bb%8e%e8%bf%99%e9%87%8c%e8%af%bb%e5%8f%96%20%09flags%20uint8%20B%20uint8%20//%20log_2%20of%20#%20of%20buckets%20%28%e6%9c%80%e5%a4%9a%e5%8f%af%e4%bb%a5%e6%94%be%20loadFactor%20*%202%5eB%20%e4%b8%aa%e5%85%83%e7%b4%a0%ef%bc%8c%e5%86%8d%e5%a4%9a%e5%b0%b1%e8%a6%81%20hashGrow%20%e4%ba%86%29%20%09noverflow%20uint16%20//%20overflow%20%e7%9a%84%20bucket%20%e7%9a%84%e8%bf%91%e4%bc%bc%e6%95%b0%20%09hash0%20uint32%20//%20hash%20seed%20%20buckets%20unsafe.Pointer%20//%202%5eB%20%e5%a4%a7%e5%b0%8f%e7%9a%84%e6%95%b0%e7%bb%84%ef%bc%8c%e5%a6%82%e6%9e%9c%20count%20==%200%20%e7%9a%84%e8%af%9d%ef%bc%8c%e5%8f%af%e8%83%bd%e6%98%af%20nil%20%09oldbuckets%20unsafe.Pointer%20//%20%e4%b8%80%e5%8d%8a%e5%a4%a7%e5%b0%8f%e7%9a%84%e4%b9%8b%e5%89%8d%e7%9a%84%20bucket%20%e6%95%b0%e7%bb%84%ef%bc%8c%e5%8f%aa%e6%9c%89%e5%9c%a8%20growing%20%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%98%af%e9%9d%9e%20nil%20%09nevacuate%20uintptr%20//%20progress%20counter%20for%20evacuation%20%28buckets%20less%20than%20this%20have%20been%20evacuated%29%20%20extra%20*mapextra%20//%20%e5%bd%93%20key%20%e5%92%8c%20value%20%e9%83%bd%e5%8f%af%e4%bb%a5%20inline%20%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%b0%b1%e4%bc%9a%e7%94%a8%e8%bf%99%e4%b8%aa%e5%ad%97%e6%ae%b5%20%7d%20%20%20%e2%80%a6%e2%80%a6&amp;source=%e6%87%92%e7%99%8c%e6%ad%a3%e6%82%a3%e8%80%85" title="åˆ†äº«åˆ°ã€ŒLinkedInã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            
                <div class="share-item telegram">
                    
                    <a href="https://t.me/share/url?url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;text=Golang%20map%e6%8e%a2%e9%99%a9" title="åˆ†äº«åˆ°ã€ŒTelegramã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                </div>
            

            
                <div class="share-item weibo">
                    
                    <a href="https://service.weibo.com/share/share.php?&amp;url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;title=Golang%20map%e6%8e%a2%e9%99%a9&amp;pic=http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap.png&amp;searchPic=false" title="åˆ†äº«åˆ°ã€Œæ–°æµªå¾®åšã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a>
                </div>
            

            
                <div class="share-item douban">
                    
                    <a href="https://www.douban.com/share/service?href=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;name=Golang%20map%e6%8e%a2%e9%99%a9&amp;text=%e5%89%8d%e8%a8%80%20map%e6%98%af%e4%b8%80%e7%a7%8d%e5%be%88%e5%9f%ba%e7%a1%80%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%8cJava%e4%b8%ad%e7%9a%84HashMap%e4%bd%bf%e7%94%a8%e6%95%b0%e7%bb%84&#43;%e9%93%be%e8%a1%a8%e7%9a%84%e6%96%b9%e5%bc%8f%e6%9d%a5%e5%ae%9e%e7%8e%b0%ef%bc%8cGolang%e5%86%85%e7%bd%aemap%e5%ba%95%e5%b1%82%e6%98%af%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e7%bb%93%e6%9e%84%e5%91%a2%ef%bc%9f%0a%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84%20%e5%9c%a8go%e4%b8%admap%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhmap%e8%bf%99%e4%b8%aa%e7%bb%93%e6%9e%84%e6%9d%a5%e8%a1%a8%e7%a4%ba%0a1%202%203%204%205%206%207%208%209%2010%2011%2012%2013%2014%2015%2016%20%20//%20A%20header%20for%20a%20Go%20map.%20type%20hmap%20struct%20%7b%20//%20Note:%20the%20format%20of%20the%20hmap%20is%20also%20encoded%20in%20cmd/compile/internal/gc/reflect.go.%20%09//%20Make%20sure%20this%20stays%20in%20sync%20with%20the%20compiler%27s%20definition.%20%09count%20int%20//%20map%20%e4%b8%ad%e7%9a%84%e5%85%83%e7%b4%a0%e4%b8%aa%e6%95%b0%ef%bc%8c%e5%bf%85%e9%a1%bb%e6%94%be%e5%9c%a8%20struct%20%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%bd%8d%e7%bd%ae%ef%bc%8c%e5%9b%a0%e4%b8%ba%20%e5%86%85%e7%bd%ae%e7%9a%84%20len%20%e5%87%bd%e6%95%b0%e4%bc%9a%e4%bb%8e%e8%bf%99%e9%87%8c%e8%af%bb%e5%8f%96%20%09flags%20uint8%20B%20uint8%20//%20log_2%20of%20#%20of%20buckets%20%28%e6%9c%80%e5%a4%9a%e5%8f%af%e4%bb%a5%e6%94%be%20loadFactor%20*%202%5eB%20%e4%b8%aa%e5%85%83%e7%b4%a0%ef%bc%8c%e5%86%8d%e5%a4%9a%e5%b0%b1%e8%a6%81%20hashGrow%20%e4%ba%86%29%20%09noverflow%20uint16%20//%20overflow%20%e7%9a%84%20bucket%20%e7%9a%84%e8%bf%91%e4%bc%bc%e6%95%b0%20%09hash0%20uint32%20//%20hash%20seed%20%20buckets%20unsafe.Pointer%20//%202%5eB%20%e5%a4%a7%e5%b0%8f%e7%9a%84%e6%95%b0%e7%bb%84%ef%bc%8c%e5%a6%82%e6%9e%9c%20count%20==%200%20%e7%9a%84%e8%af%9d%ef%bc%8c%e5%8f%af%e8%83%bd%e6%98%af%20nil%20%09oldbuckets%20unsafe.Pointer%20//%20%e4%b8%80%e5%8d%8a%e5%a4%a7%e5%b0%8f%e7%9a%84%e4%b9%8b%e5%89%8d%e7%9a%84%20bucket%20%e6%95%b0%e7%bb%84%ef%bc%8c%e5%8f%aa%e6%9c%89%e5%9c%a8%20growing%20%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%98%af%e9%9d%9e%20nil%20%09nevacuate%20uintptr%20//%20progress%20counter%20for%20evacuation%20%28buckets%20less%20than%20this%20have%20been%20evacuated%29%20%20extra%20*mapextra%20//%20%e5%bd%93%20key%20%e5%92%8c%20value%20%e9%83%bd%e5%8f%af%e4%bb%a5%20inline%20%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%b0%b1%e4%bc%9a%e7%94%a8%e8%bf%99%e4%b8%aa%e5%ad%97%e6%ae%b5%20%7d%20%20%20%e2%80%a6%e2%80%a6" title="åˆ†äº«åˆ°ã€Œè±†ç“£ã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412l-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952 0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03Z"/></svg></a>
                </div>
            

            
                <div class="share-item qq">
                    
                    <a href="https://connect.qq.com/widget/shareqq/index.html?url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;title=Golang%20map%e6%8e%a2%e9%99%a9&amp;summary=%e5%89%8d%e8%a8%80%20map%e6%98%af%e4%b8%80%e7%a7%8d%e5%be%88%e5%9f%ba%e7%a1%80%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%8cJava%e4%b8%ad%e7%9a%84HashMap%e4%bd%bf%e7%94%a8%e6%95%b0%e7%bb%84&#43;%e9%93%be%e8%a1%a8%e7%9a%84%e6%96%b9%e5%bc%8f%e6%9d%a5%e5%ae%9e%e7%8e%b0%ef%bc%8cGolang%e5%86%85%e7%bd%aemap%e5%ba%95%e5%b1%82%e6%98%af%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e7%bb%93%e6%9e%84%e5%91%a2%ef%bc%9f%0a%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84%20%e5%9c%a8go%e4%b8%admap%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhmap%e8%bf%99%e4%b8%aa%e7%bb%93%e6%9e%84%e6%9d%a5%e8%a1%a8%e7%a4%ba%0a1%202%203%204%205%206%207%208%209%2010%2011%2012%2013%2014%2015%2016%20%20//%20A%20header%20for%20a%20Go%20map.%20type%20hmap%20struct%20%7b%20//%20Note:%20the%20format%20of%20the%20hmap%20is%20also%20encoded%20in%20cmd/compile/internal/gc/reflect.go.%20%09//%20Make%20sure%20this%20stays%20in%20sync%20with%20the%20compiler%27s%20definition.%20%09count%20int%20//%20map%20%e4%b8%ad%e7%9a%84%e5%85%83%e7%b4%a0%e4%b8%aa%e6%95%b0%ef%bc%8c%e5%bf%85%e9%a1%bb%e6%94%be%e5%9c%a8%20struct%20%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%bd%8d%e7%bd%ae%ef%bc%8c%e5%9b%a0%e4%b8%ba%20%e5%86%85%e7%bd%ae%e7%9a%84%20len%20%e5%87%bd%e6%95%b0%e4%bc%9a%e4%bb%8e%e8%bf%99%e9%87%8c%e8%af%bb%e5%8f%96%20%09flags%20uint8%20B%20uint8%20//%20log_2%20of%20#%20of%20buckets%20%28%e6%9c%80%e5%a4%9a%e5%8f%af%e4%bb%a5%e6%94%be%20loadFactor%20*%202%5eB%20%e4%b8%aa%e5%85%83%e7%b4%a0%ef%bc%8c%e5%86%8d%e5%a4%9a%e5%b0%b1%e8%a6%81%20hashGrow%20%e4%ba%86%29%20%09noverflow%20uint16%20//%20overflow%20%e7%9a%84%20bucket%20%e7%9a%84%e8%bf%91%e4%bc%bc%e6%95%b0%20%09hash0%20uint32%20//%20hash%20seed%20%20buckets%20unsafe.Pointer%20//%202%5eB%20%e5%a4%a7%e5%b0%8f%e7%9a%84%e6%95%b0%e7%bb%84%ef%bc%8c%e5%a6%82%e6%9e%9c%20count%20==%200%20%e7%9a%84%e8%af%9d%ef%bc%8c%e5%8f%af%e8%83%bd%e6%98%af%20nil%20%09oldbuckets%20unsafe.Pointer%20//%20%e4%b8%80%e5%8d%8a%e5%a4%a7%e5%b0%8f%e7%9a%84%e4%b9%8b%e5%89%8d%e7%9a%84%20bucket%20%e6%95%b0%e7%bb%84%ef%bc%8c%e5%8f%aa%e6%9c%89%e5%9c%a8%20growing%20%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%98%af%e9%9d%9e%20nil%20%09nevacuate%20uintptr%20//%20progress%20counter%20for%20evacuation%20%28buckets%20less%20than%20this%20have%20been%20evacuated%29%20%20extra%20*mapextra%20//%20%e5%bd%93%20key%20%e5%92%8c%20value%20%e9%83%bd%e5%8f%af%e4%bb%a5%20inline%20%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%b0%b1%e4%bc%9a%e7%94%a8%e8%bf%99%e4%b8%aa%e5%ad%97%e6%ae%b5%20%7d%20%20%20%e2%80%a6%e2%80%a6&amp;pics=http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap.png&amp;site=%e6%87%92%e7%99%8c%e6%ad%a3%e6%82%a3%e8%80%85" title="åˆ†äº«åˆ°ã€ŒQQã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a>
                </div>
            

            
                <div class="share-item qzone">
                    
                    <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.wemeng.top/posts/golang-map%E6%8E%A2%E9%99%A9/&amp;title=Golang%20map%e6%8e%a2%e9%99%a9&amp;summary=%e5%89%8d%e8%a8%80%20map%e6%98%af%e4%b8%80%e7%a7%8d%e5%be%88%e5%9f%ba%e7%a1%80%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%8cJava%e4%b8%ad%e7%9a%84HashMap%e4%bd%bf%e7%94%a8%e6%95%b0%e7%bb%84&#43;%e9%93%be%e8%a1%a8%e7%9a%84%e6%96%b9%e5%bc%8f%e6%9d%a5%e5%ae%9e%e7%8e%b0%ef%bc%8cGolang%e5%86%85%e7%bd%aemap%e5%ba%95%e5%b1%82%e6%98%af%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e7%bb%93%e6%9e%84%e5%91%a2%ef%bc%9f%0a%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84%20%e5%9c%a8go%e4%b8%admap%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhmap%e8%bf%99%e4%b8%aa%e7%bb%93%e6%9e%84%e6%9d%a5%e8%a1%a8%e7%a4%ba%0a1%202%203%204%205%206%207%208%209%2010%2011%2012%2013%2014%2015%2016%20%20//%20A%20header%20for%20a%20Go%20map.%20type%20hmap%20struct%20%7b%20//%20Note:%20the%20format%20of%20the%20hmap%20is%20also%20encoded%20in%20cmd/compile/internal/gc/reflect.go.%20%09//%20Make%20sure%20this%20stays%20in%20sync%20with%20the%20compiler%27s%20definition.%20%09count%20int%20//%20map%20%e4%b8%ad%e7%9a%84%e5%85%83%e7%b4%a0%e4%b8%aa%e6%95%b0%ef%bc%8c%e5%bf%85%e9%a1%bb%e6%94%be%e5%9c%a8%20struct%20%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%bd%8d%e7%bd%ae%ef%bc%8c%e5%9b%a0%e4%b8%ba%20%e5%86%85%e7%bd%ae%e7%9a%84%20len%20%e5%87%bd%e6%95%b0%e4%bc%9a%e4%bb%8e%e8%bf%99%e9%87%8c%e8%af%bb%e5%8f%96%20%09flags%20uint8%20B%20uint8%20//%20log_2%20of%20#%20of%20buckets%20%28%e6%9c%80%e5%a4%9a%e5%8f%af%e4%bb%a5%e6%94%be%20loadFactor%20*%202%5eB%20%e4%b8%aa%e5%85%83%e7%b4%a0%ef%bc%8c%e5%86%8d%e5%a4%9a%e5%b0%b1%e8%a6%81%20hashGrow%20%e4%ba%86%29%20%09noverflow%20uint16%20//%20overflow%20%e7%9a%84%20bucket%20%e7%9a%84%e8%bf%91%e4%bc%bc%e6%95%b0%20%09hash0%20uint32%20//%20hash%20seed%20%20buckets%20unsafe.Pointer%20//%202%5eB%20%e5%a4%a7%e5%b0%8f%e7%9a%84%e6%95%b0%e7%bb%84%ef%bc%8c%e5%a6%82%e6%9e%9c%20count%20==%200%20%e7%9a%84%e8%af%9d%ef%bc%8c%e5%8f%af%e8%83%bd%e6%98%af%20nil%20%09oldbuckets%20unsafe.Pointer%20//%20%e4%b8%80%e5%8d%8a%e5%a4%a7%e5%b0%8f%e7%9a%84%e4%b9%8b%e5%89%8d%e7%9a%84%20bucket%20%e6%95%b0%e7%bb%84%ef%bc%8c%e5%8f%aa%e6%9c%89%e5%9c%a8%20growing%20%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%98%af%e9%9d%9e%20nil%20%09nevacuate%20uintptr%20//%20progress%20counter%20for%20evacuation%20%28buckets%20less%20than%20this%20have%20been%20evacuated%29%20%20extra%20*mapextra%20//%20%e5%bd%93%20key%20%e5%92%8c%20value%20%e9%83%bd%e5%8f%af%e4%bb%a5%20inline%20%e7%9a%84%e6%97%b6%e5%80%99%ef%bc%8c%e5%b0%b1%e4%bc%9a%e7%94%a8%e8%bf%99%e4%b8%aa%e5%ad%97%e6%ae%b5%20%7d%20%20%20%e2%80%a6%e2%80%a6&amp;pics=http://www.wemeng.top/Golang-map%E6%8E%A2%E9%99%A9/hmap.png&amp;site=%e6%87%92%e7%99%8c%e6%ad%a3%e6%82%a3%e8%80%85" title="åˆ†äº«åˆ°ã€ŒQQ ç©ºé—´ã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532c-.104 0-.251.051-.349.238-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477 0 0 0 .125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061c.103-.017.201.061.201.061s6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463 0 0 0 .159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5 0 0 1 2.861-2.155c1.285-.968 3.559-2.47 3.559-2.731 0-.285-2.144-.781-4.037-.781-1.945 0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276 0 .342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688 0 .342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477 0 0 0 .127-.449z"/></svg></a>
                </div>
            

            
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="é€šè¿‡ã€ŒäºŒç»´ç ã€"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('http:\/\/www.wemeng.top\/posts\/golang-map%E6%8E%A2%E9%99%A9\/');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">ç›¸å…³æ–‡ç« ï¼š<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/golang%E5%8F%8D%E5%B0%84/" class="related-link">Golangåå°„</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/golang%E6%8C%87%E9%92%88/" class="related-link">GolangæŒ‡é’ˆ</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/golang-plan9%E6%B1%87%E7%BC%96/" class="related-link">Golang Plan9æ±‡ç¼–</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/golang-string%E6%8E%A2%E9%99%A9/" class="related-link">Golang stringæ¢é™©</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/timer%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" class="related-link">Timeræºç é˜…è¯»</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/golang%E5%9F%BA%E7%A1%80/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>GolangåŸºç¡€</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/posts/%E4%B8%BA%E4%BB%80%E4%B9%88%E7%BB%8F%E6%B5%8E%E5%8D%B1%E6%9C%BA%E4%BB%A5%E5%90%8E%E8%B4%A7%E5%B8%81%E9%83%BD%E4%BC%9A%E8%B4%AC%E5%80%BC/" rel="prev">&lt; ä¸ºä»€ä¹ˆç»æµå±æœºä»¥åè´§å¸éƒ½ä¼šè´¬å€¼ï¼Ÿ</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/posts/golang-string%E6%8E%A2%E9%99%A9/" rel="next">Golang stringæ¢é™© &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">Â©&nbsp;2020â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;æ‡’ç™Œæ­£æ‚£è€…</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="mailto:zengqiang96@gmail.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/zengqiang96" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://twitter.com/lazzyq" target="_blank" rel="external noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://t.me/lazzyq" target="_blank" rel="external noopener" title="Telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon social-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        


    <script>
    if (typeof MathJax === 'undefined') {
        window.MathJax = {
            loader: {
                load: ['[tex]/mhchem']
            },
            
            tex: {
                inlineMath: {'[+]': [['$', '$']]},
                tags: 'ams',
                packages: {'[+]': ['mhchem']}
            }
        };
        (function() {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
            script.defer = true;
            document.head.appendChild(script);
        })();
    } else {
        MathJax.texReset();
        MathJax.typeset();
    }
</script>








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
